<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jarrett Byrnes">

<title>Full Luxury Bayesian Structural Equation Modeling with brms</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="bayesian_sem_files/libs/clipboard/clipboard.min.js"></script>
<script src="bayesian_sem_files/libs/quarto-html/quarto.js"></script>
<script src="bayesian_sem_files/libs/quarto-html/popper.min.js"></script>
<script src="bayesian_sem_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="bayesian_sem_files/libs/quarto-html/anchor.min.js"></script>
<link href="bayesian_sem_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="bayesian_sem_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="bayesian_sem_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="bayesian_sem_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="bayesian_sem_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#libraries-youll-need" id="toc-libraries-youll-need" class="nav-link active" data-scroll-target="#libraries-youll-need">Libraries You’ll Need</a></li>
  <li><a href="#the-quest" id="toc-the-quest" class="nav-link" data-scroll-target="#the-quest">The Quest</a></li>
  <li><a href="#a-bayesian-model-of-direct-and-indirect-effects" id="toc-a-bayesian-model-of-direct-and-indirect-effects" class="nav-link" data-scroll-target="#a-bayesian-model-of-direct-and-indirect-effects">A Bayesian Model of Direct and Indirect Effects</a></li>
  <li><a href="#simulating-a-system" id="toc-simulating-a-system" class="nav-link" data-scroll-target="#simulating-a-system">Simulating a System</a></li>
  <li><a href="#calculating-a-direct-and-indirect-effect" id="toc-calculating-a-direct-and-indirect-effect" class="nav-link" data-scroll-target="#calculating-a-direct-and-indirect-effect">Calculating a Direct and Indirect Effect</a>
  <ul>
  <li><a href="#ropes" id="toc-ropes" class="nav-link" data-scroll-target="#ropes">ROPEs</a></li>
  <li><a href="#comparing-models-to-test-mediation" id="toc-comparing-models-to-test-mediation" class="nav-link" data-scroll-target="#comparing-models-to-test-mediation">Comparing Models to Test Mediation</a></li>
  </ul></li>
  <li><a href="#assessing-model-fit" id="toc-assessing-model-fit" class="nav-link" data-scroll-target="#assessing-model-fit">Assessing Model Fit</a>
  <ul>
  <li><a href="#fit-of-response-variables" id="toc-fit-of-response-variables" class="nav-link" data-scroll-target="#fit-of-response-variables">Fit of response variables</a></li>
  <li><a href="#conditional-independence-tests" id="toc-conditional-independence-tests" class="nav-link" data-scroll-target="#conditional-independence-tests">Conditional Independence Tests</a></li>
  <li><a href="#comparison-against-a-saturated-model" id="toc-comparison-against-a-saturated-model" class="nav-link" data-scroll-target="#comparison-against-a-saturated-model">Comparison Against a Saturated Model</a></li>
  <li><a href="#how-does-a-saturated-model-do-vis-a-vis-posterior-prediction-of-our-data" id="toc-how-does-a-saturated-model-do-vis-a-vis-posterior-prediction-of-our-data" class="nav-link" data-scroll-target="#how-does-a-saturated-model-do-vis-a-vis-posterior-prediction-of-our-data">How does a saturated model do vis a vis posterior prediction of our data?</a></li>
  <li><a href="#how-good-is-a-saturated-model-at-out-of-sample-prediction-versus-our-sparse-model" id="toc-how-good-is-a-saturated-model-at-out-of-sample-prediction-versus-our-sparse-model" class="nav-link" data-scroll-target="#how-good-is-a-saturated-model-at-out-of-sample-prediction-versus-our-sparse-model">How good is a saturated model at out of sample prediction versus our sparse model?</a></li>
  <li><a href="#what-are-the-odds-of-one-model-versus-the-other" id="toc-what-are-the-odds-of-one-model-versus-the-other" class="nav-link" data-scroll-target="#what-are-the-odds-of-one-model-versus-the-other">What are the odds of one model versus the other?</a></li>
  </ul></li>
  <li><a href="#the-power-of-priors" id="toc-the-power-of-priors" class="nav-link" data-scroll-target="#the-power-of-priors">The Power of Priors</a></li>
  <li><a href="#correlated-error" id="toc-correlated-error" class="nav-link" data-scroll-target="#correlated-error">Correlated Error</a></li>
  <li><a href="#confounders-and-instruments" id="toc-confounders-and-instruments" class="nav-link" data-scroll-target="#confounders-and-instruments">Confounders and Instruments</a></li>
  <li><a href="#latent-variables" id="toc-latent-variables" class="nav-link" data-scroll-target="#latent-variables">Latent Variables</a></li>
  <li><a href="#multilevel-sem" id="toc-multilevel-sem" class="nav-link" data-scroll-target="#multilevel-sem">Multilevel SEM</a></li>
  <li><a href="#comments" id="toc-comments" class="nav-link" data-scroll-target="#comments">Comments?</a></li>
  </ul>
</nav>
</div>
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Full Luxury Bayesian Structural Equation Modeling with brms</h1>
</div>



<div class="quarto-title-meta column-page-left">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jarrett Byrnes </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="libraries-youll-need" class="level2">
<h2 class="anchored" data-anchor-id="libraries-youll-need">Libraries You’ll Need</h2>
<p>Below is a bit of a mental exegesis on Bayesian SEM with brms. If you wish to follow along with R code, load up the following libraries, and then let’s let her rip. If you have comments or corrections, post them as an <a href="https://github.com/jebyrnes/Ecological-SEMs-in-lavaan/issues">issue on the repo for this tutorial</a>.</p>
<div class="cell" data-messages="false">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## If you don't have it, pacman is great</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="do">## as you never need to have a package load</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="do">## fail because it's not installed ever again</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("pacman")</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># our heroes of fitting</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  lavaan, brms, piecewiseSEM, rstan,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># a little help</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  tidybayes, dplyr, tidyr, purrr,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  emmeans, readr,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pretty coefficients</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  broom, broom.mixed,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># graph things</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  ggdag, dagitty,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for plotting</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  ggplot2, patchwork)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># aesthetics</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_classic</span>(<span class="at">base_size =</span> <span class="dv">12</span>))</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># options to make brms faster on a multicore</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># machine - change as needed</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co"># options(brms.backend = "cmdstanr", </span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co">#         mc.cores = parallel::detectCores(),</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co">#         threads = 2)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-quest" class="level2">
<h2 class="anchored" data-anchor-id="the-quest">The Quest</h2>
<p>I’ve been teaching <a href="https://esajournals.onlinelibrary.wiley.com/doi/10.1890/09-0464.1">Structural Equation Modeling</a> for some years. I’ve been privileged enough to be supported by amazing people like Jim Grace and Jon Lefcheck. I’ve had conversations with Ecologists all over the world about what they’re looking to do with SEM and what roadblocks they face.</p>
<p>In lectures I’ve seen from Jim Grace, whose work I’ve deeply admired since <a href="https://www.amazon.com/Structural-Equation-Modeling-Natural-Systems/dp/0521546532">reading his book</a>, he introduces a few generations of SEM</p>
<ol type="1">
<li><p>Correlation-based SEM a.k.a. Path Analysis from Sewall Wright</p></li>
<li><p>Covariance-based SEM from Karl Joreskog</p></li>
<li><p>piecewiseSEM as developed by Bill Shipley and popularized by Jon Lefcheck in his <a href="https://besjournals.onlinelibrary.wiley.com/doi/10.1111/2041-210X.12512">piecewiseSEM package</a></p></li>
<li><p>Bayesian SEM</p></li>
</ol>
<p>This later he presented as a next or final generation of SEM, and in a mini-course lecture, proceeded to show the class how to implement it in JAGS (this was a while back).</p>
<p>Why is Bayesian SEM a culmination of the development of the technique? Well, better to ask why Bayes. For which I can provide another enumerated list.</p>
<ol type="1">
<li><p>Bayesian techniques allow the incorporation of reasonable prior information into models (priors!)</p></li>
<li><p>Bayesian techniques allow for the creation of models that, when fed distributions of parameters can turn out simulations of data and when fed data can turn out distributions of parameters, allowing for a more dynamic modeling process and evaluation of robustness - even before data collection (thanks, <a href="https://xcelab.net/rm/">Richard McElreath</a>!)</p></li>
<li><p>Bayesian techniques, particularly as implemented by modern probabilistic programming languages, allow for arbitrarily complex model structures - perfect for SEM.</p></li>
</ol>
<p>This later was part of the motivation behind piecewiseSEM approaches - while covariance-based SEM can be tortured into supporting things like glms, categorical variables, mixed models, and more, piecewiseSEM has a more natural ability to accomodate those modeling elements. On the other hand, it’s been a bear to bring elements like latent variables, multi-level SEMS, and more to the party.</p>
<p>As a fan of Bayesian methods, I’ve been noodling around with how they can work with SEM. They can be implemented in stan, JAGS, or, more intelligibly, in rethinking. There, they can accomodate classical covariance-based techniques (see <a href="">blavaan</a>) or be built for more piecewise approaches. With these approaches, they can even fold in latent variables as an unmeasured quantity with indicators being driven by this underlying latent variable.</p>
<p>As an educator and someone who works with students at a lot of levels, I wanted a Bayesian SEM approach that was more user-accessbile, and had robust tooling. Something that I wouldn’t have to teach a whole new language to use and that would allow someone to step from the world of using linear models in R straight into the seat of SEMs.</p>
<p>The tooling I wanted to use was <a href="https://cran.r-project.org/web/packages/brms/index.html">brms</a>, a brilliant user-accessible Bayesian analysis package by Paul Buerkner. IMHO has done for Bayesian methods what <a href="http://lavaan.org">lavaan</a> has done for SEM, frankly.</p>
<p>But - multivariate modeling was not super high on the list when the package started, and the bits and pieces have taken a while to come together. There are a few nice long threads in the github issues about it, but, I’ll admit, I’d kind of given up.</p>
<p>Until I had the confluence of two things happen the other day - a paper to review discussing Bayesian SEM among other options with brms, but that made a few statements about it that seemed out of date, and a report I had to write, and hence I was procractinating a bit.</p>
<p>So I took a dip in, and, well, things have really changed.</p>
<p>Let’s take a look at where things are now, as, I think it’s exciting.</p>
</section>
<section id="a-bayesian-model-of-direct-and-indirect-effects" class="level2">
<h2 class="anchored" data-anchor-id="a-bayesian-model-of-direct-and-indirect-effects">A Bayesian Model of Direct and Indirect Effects</h2>
<p>Let’s start with a classic teaching data set - the <code>keeley</code> data from the <code>piecewiseSEM</code> package. It has a number of variables describing plant communities that ultimately predict species richness. Let’s look at a classic example - how stand age affected fire severity and then how this pre-burn stand age and fire severity affect species richness. Let’s plot it using <code>ggdag</code>. For more on plotting graphs nicely, I wrote a little tutorial <a href="https://biol607.github.io/lab/dagitty.html">here</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dagify</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  firesev <span class="sc">~</span> age,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  rich <span class="sc">~</span> firesev <span class="sc">+</span> age,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">coords =</span> <span class="fu">list</span>(</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">c</span>(<span class="at">age =</span> <span class="dv">1</span>, <span class="at">rich =</span> <span class="dv">2</span>, <span class="at">firesev =</span> <span class="fl">1.5</span>),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="at">age =</span> <span class="dv">1</span>, <span class="at">rich =</span> <span class="dv">1</span>, <span class="at">firesev =</span> <span class="sc">-</span><span class="dv">1</span>))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend)) <span class="sc">+</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_point</span>(<span class="at">shape =</span> <span class="dv">22</span>, </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">size =</span> <span class="dv">18</span>, </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_text</span>() <span class="sc">+</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dag_edges</span>() <span class="sc">+</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_dag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/plot_dag_firesev-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is a nice little example, as it lets you dig into direct and indirect effects of age. It’s simple to fit in lavaan or piecewiseSEM.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(keeley)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>rich_lavaan <span class="ot">&lt;-</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sem</span>(<span class="st">"</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">      rich ~ age + firesev</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">      firesev ~ age"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> keeley)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>rich_piecewise <span class="ot">&lt;-</span> </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">psem</span>(<span class="fu">lm</span>(rich <span class="sc">~</span> age <span class="sc">+</span> firesev, <span class="at">data =</span> keeley),</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>       <span class="fu">lm</span>(firesev <span class="sc">~</span> age, <span class="at">data =</span> keeley),</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">data =</span> keeley)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># check out those coefs</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(rich_lavaan)<span class="sc">$</span>pe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      lhs op     rhs exo          est          se         z       pvalue
1    rich  ~     age   0  -0.20455529  0.13046209 -1.567929 1.168977e-01
2    rich  ~ firesev   0  -2.65645229  0.99217811 -2.677395 7.419720e-03
3 firesev  ~     age   0   0.05967903  0.01235052  4.832105 1.350972e-06
4    rich ~~    rich   0 189.93089581 28.31322627  6.708204 1.970335e-11
5 firesev ~~ firesev   0   2.14374847  0.31957115  6.708204 1.970335e-11
6     age ~~     age   1 156.15666667  0.00000000        NA           NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coefs</span>(rich_piecewise)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Response Predictor Estimate Std.Error DF Crit.Value P.Value Std.Estimate    
1     rich       age  -0.2046    0.1327 87    -1.5416  0.1268      -0.1702    
2     rich   firesev  -2.6565    1.0091 87    -2.6324  0.0100      -0.2906   *
3  firesev       age   0.0597    0.0125 88     4.7781  0.0000       0.4539 ***</code></pre>
</div>
</div>
<p>We can do a lot with these - plot, look at standardize coefficients. With piecewise, we can use the <a href="https://github.com/jebyrnes/sinterval"><code>sinterval</code></a> library to even simulate from it (a project I’m still noodling on). This later is important when it comes to thinking about calculating direct and indirect effects with nonlinear models.</p>
<p>How do we do this in a Bayesian model? <code>brms</code> allows us to “add” together different formulas, and then has some options to check whether residual correlations between endogenous variables should be modeled - which we don’t want to do.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>rich_bf <span class="ot">&lt;-</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(rich <span class="sc">~</span> age <span class="sc">+</span> firesev) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(firesev <span class="sc">~</span> age) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_rescor</span>(<span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>OK, so, that’s the model of our data generating process from the DAG above. Quite similar to what we had with lavaan and piecewiseSEM, no? Now, what about fitting? For the moment, we’re going to stick with the default priors from <code>brms</code> - which is a shame, as we can do better - but, more on that later.</p>
<p>What are those priors?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(rich_bf,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> keeley)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  prior     class    coef group    resp dpar nlpar lb ub
                 (flat)         b                                       
                 (flat) Intercept                                       
                 (flat)         b               firesev                 
                 (flat)         b     age       firesev                 
 student_t(3, 4.3, 2.5) Intercept               firesev                 
   student_t(3, 0, 2.5)     sigma               firesev             0   
                 (flat)         b                  rich                 
                 (flat)         b     age          rich                 
                 (flat)         b firesev          rich                 
 student_t(3, 50, 19.3) Intercept                  rich                 
  student_t(3, 0, 19.3)     sigma                  rich             0   
       source
      default
      default
      default
 (vectorized)
      default
      default
      default
 (vectorized)
 (vectorized)
      default
      default</code></pre>
</div>
</div>
<p>So, we have flat priors for all slopes and a Student’s T for the intercept and sigma. Here, the parameters are the degrees of freedom, mean, and standard deviation of the population. Note the lower bound is set at 0. They also vary by response variable, with means and sigmas derived from the data. So you can understand what those are, let’s take a look for fire severity!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># intercept plot</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">15</span>, .<span class="dv">1</span>),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">dstudent_t</span>(x, <span class="at">df =</span> <span class="dv">3</span>, </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">mu =</span> <span class="fl">4.3</span>, <span class="at">sigma =</span> <span class="fl">2.5</span>)) <span class="sc">|&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>x, <span class="at">y=</span>y)) <span class="sc">+</span> </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(keeley<span class="sc">$</span>firesev),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"firesev intercept prior"</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"dashed line = mean of firesev"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/student_plots-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sd</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">6</span>, .<span class="dv">1</span>),</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">dstudent_t</span>(x, <span class="at">df =</span> <span class="dv">3</span>, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="fl">2.5</span>)) <span class="sc">|&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>x, <span class="at">y=</span>y)) <span class="sc">+</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">sd</span>(keeley<span class="sc">$</span>firesev),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"firesev sd prior"</span>,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"dashed line = sd of firesev"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/student_plots-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>OK, that’s enough priors for the moment. We’ll get back to them soon.</p>
<p>Now, let’s fit this model and first just look at the coefficients relative to our prior (hehe) efforts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># note, backend and threads are for speed</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># and file is so that the first time I fit, the model </span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># is saved out so I don't have to refit if I rerun</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># when compiling this document</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>rich_brms <span class="ot">&lt;-</span> <span class="fu">brm</span>(rich_bf, <span class="at">data =</span> keeley,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">file =</span> <span class="st">"fit_models/rich_brms.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s start with a plain old coefficient comparison.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(rich_lavaan)[,<span class="fu">c</span>(<span class="st">"term"</span>, <span class="st">"estimate"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  term               estimate
  &lt;chr&gt;                 &lt;dbl&gt;
1 rich ~ age          -0.205 
2 rich ~ firesev      -2.66  
3 firesev ~ age        0.0597
4 rich ~~ rich       190.    
5 firesev ~~ firesev   2.14  
6 age ~~ age         156.    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coefs</span>(rich_piecewise)[,<span class="fu">c</span>(<span class="st">"Response"</span>, <span class="st">"Predictor"</span>, <span class="st">"Estimate"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Response Predictor Estimate
1     rich       age  -0.2046
2     rich   firesev  -2.6565
3  firesev       age   0.0597</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(rich_brms)[,<span class="fu">c</span>(<span class="st">"response"</span>, <span class="st">"term"</span>, <span class="st">"estimate"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  response term            estimate
  &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;
1 rich     (Intercept)      66.5   
2 firesev  (Intercept)       3.04  
3 rich     age              -0.204 
4 rich     firesev          -2.65  
5 firesev  age               0.0598
6 rich     sd__Observation  14.2   
7 firesev  sd__Observation   1.50  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lavaan gives variance, brms sd</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># so, for richness for comparison</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fl">14.2</span><span class="sc">^</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 201.64</code></pre>
</div>
</div>
<p>Yep, pretty close! Everything looks good!</p>
</section>
<section id="simulating-a-system" class="level2">
<h2 class="anchored" data-anchor-id="simulating-a-system">Simulating a System</h2>
<p>OK! You have a fit model! Now, we want to use it as a query engine. For example, what if stand age had been 25? What would we predict species richness should be here?</p>
<p>We can do this by hand with <code>lavaan</code>, pulling including meanstructures, pulling out coefficient covariance matrices. I’ve written code in the past to do this, but, seems like some of the underlying functions have changed. Really need to re-write that.</p>
<p>We can do it with <code>piecewiseSEM</code> using a package I wrote called <a href="https://github.com/jebyrnes/sinterval"><code>sinterval</code></a>.</p>
<p>But - what about Bayes? <code>brms</code> has a <code>predict</code> method. And there is also <a href="https://mjskay.github.io/tidybayes/"><code>tidybayes</code></a> and its functions (which I love). At this point, we can’t just put in an age and let the machinery chug - we have to do some work, but, it will get there one day.</p>
<p>So we can start with part 1 - going from age to fire severity. We have to give the data an NA for fire severity as we need to include a placeholder for richness calculation - even though it will be NA. Here it is with both brms and tidybayes</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>new_age_dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">age =</span> <span class="dv">25</span>, <span class="at">firesev =</span> <span class="cn">NA</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(rich_brms, <span class="at">newdata =</span> new_age_dat) <span class="sc">|&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in rnorm(.x1, mean = .x2, sd = .x3): NAs produced</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 8
  Estimate.rich Est.Error.rich Q2.5.rich Q97.5.rich Estimate.firesev
          &lt;dbl&gt;          &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;            &lt;dbl&gt;
1           NaN             NA        NA         NA             4.53
# ℹ 3 more variables: Est.Error.firesev &lt;dbl&gt;, Q2.5.firesev &lt;dbl&gt;,
#   Q97.5.firesev &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">linpred_draws</span>(rich_brms, new_age_dat) <span class="sc">|&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(.category) <span class="sc">|&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.linpred =</span> <span class="fu">mean</span>(.linpred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  .category .linpred
  &lt;fct&gt;        &lt;dbl&gt;
1 rich         NA   
2 firesev       4.53</code></pre>
</div>
</div>
<p>These are nice, and it’s easy to manipulate the output to, say, get the richness value based on average predictions. What if we want more though? Let’s say we want fit, but, we want to fully propogate uncertainty in parameters through - and not just for one value of age, but a lot of them! Now we want to look at the posterior. Let’s look at this with <code>linpred_draws</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>new_age_dat_more <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">age =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">firesev =</span> <span class="cn">NA</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">linpred_draws</span>(rich_brms, new_age_dat_more) <span class="sc">|&gt;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.category<span class="sc">==</span><span class="st">"firesev"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 40,000 × 8
# Groups:   age, firesev, .row, .category [10]
     age firesev  .row .chain .iteration .draw .category .linpred
   &lt;int&gt; &lt;lgl&gt;   &lt;int&gt;  &lt;int&gt;      &lt;int&gt; &lt;int&gt; &lt;fct&gt;        &lt;dbl&gt;
 1     1 NA          1     NA         NA     1 firesev       3.28
 2     1 NA          1     NA         NA     2 firesev       2.97
 3     1 NA          1     NA         NA     3 firesev       2.73
 4     1 NA          1     NA         NA     4 firesev       3.33
 5     1 NA          1     NA         NA     5 firesev       3.14
 6     1 NA          1     NA         NA     6 firesev       3.24
 7     1 NA          1     NA         NA     7 firesev       2.95
 8     1 NA          1     NA         NA     8 firesev       3.25
 9     1 NA          1     NA         NA     9 firesev       3.35
10     1 NA          1     NA         NA    10 firesev       2.87
# ℹ 39,990 more rows</code></pre>
</div>
</div>
<p>Whoah. 40K posterior draws. That’s because we have 10 values and 4K draws from the posterior. If we propagate in even a moderately sized model, that’s going to get out of control fast. So, you’ll need to trim down the number of samples in each round of drawing. Here, let’s go with 100.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>rich_pred_fit <span class="ot">&lt;-</span> <span class="fu">linpred_draws</span>(rich_brms, </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">newdata =</span> new_age_dat_more, </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">ndraws =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.category<span class="sc">==</span><span class="st">"firesev"</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age, .linpred) <span class="sc">|&gt;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">firesev =</span> .linpred) <span class="sc">|&gt;</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">linpred_draws</span>(rich_brms, </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">newdata =</span> _,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">ndraws =</span> <span class="dv">100</span>) </span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>rich_pred_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 200,000 × 8
# Groups:   age, firesev, .row, .category [2,000]
     age firesev  .row .chain .iteration .draw .category .linpred
   &lt;int&gt;   &lt;dbl&gt; &lt;int&gt;  &lt;int&gt;      &lt;int&gt; &lt;int&gt; &lt;fct&gt;        &lt;dbl&gt;
 1     1    3.64     1     NA         NA     1 rich          57.0
 2     1    3.64     1     NA         NA     2 rich          54.1
 3     1    3.64     1     NA         NA     3 rich          51.9
 4     1    3.64     1     NA         NA     4 rich          56.7
 5     1    3.64     1     NA         NA     5 rich          61.0
 6     1    3.64     1     NA         NA     6 rich          56.3
 7     1    3.64     1     NA         NA     7 rich          60.5
 8     1    3.64     1     NA         NA     8 rich          61.2
 9     1    3.64     1     NA         NA     9 rich          56.1
10     1    3.64     1     NA         NA    10 rich          54.6
# ℹ 199,990 more rows</code></pre>
</div>
</div>
<p>What’s lovely about this output is that, because we had age as a predictor again, we actually get the linear predictor of fire severity - and lots of it - back for free. This means we can plot it all out using <code>stat_lineribbon</code> from <code>tidybayes</code> or <code>ggdist</code> and see all of the relationships with full error propogation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rich_pred_fit,</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> .linpred)) <span class="sc">+</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_lineribbon</span>(<span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"pink"</span>, <span class="st">"lightblue"</span>, <span class="st">"darkgreen"</span>)) <span class="sc">+</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(.category), <span class="at">scale =</span> <span class="st">"free_y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/ggdistplot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note, if we wanted, we could have <strong>also</strong> done this with <code>predicted_draws</code> in order to address, say, nonlinear relationships in our model and/or to get propagation of error from external sources. This intervals are going to be wider, as they’ll incorporate additional uncertainty. Try going back and using that function instead to see what difference it makes - it’s substantial, which isn’t surprising given the low R<sup>2</sup> of the relationships. But also….because some other elements are lurking here worth examing, namely -</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bayes_R2</span>(rich_brms)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Estimate  Est.Error       Q2.5     Q97.5
R2rich    0.1657633 0.06093223 0.05215775 0.2900339
R2firesev 0.2061607 0.06837295 0.07097597 0.3360584</code></pre>
</div>
</div>
</section>
<section id="calculating-a-direct-and-indirect-effect" class="level2">
<h2 class="anchored" data-anchor-id="calculating-a-direct-and-indirect-effect">Calculating a Direct and Indirect Effect</h2>
<p>We fit this model, presumably, in order to evaluate the direct and indirect effect of pre-burn stand age on species richness. In a frequentist world, we’d pop in and look at p values. But, we’re not in that world any more, and we want to think like a Bayesian if we’re evaluating a hypothesis.</p>
<p>Sure, we can look at slopes and multiply them as we’ve done with linear SEM. But, what if this had been a more complex SEM with nonlinear relationships? We need a more general solution, which has been outlined in several places. The Direct effect of age is the effect of a one unit change in age, but holding all mediators - in this case fire severity - constant. The indirect effect is the effect on richness by a change in the mediator - fire severity - of a magnitude were age to have changed by one unit, but holding the age effect constant.</p>
<p>A mouthful. We can represent this in equations, but, it’s a bit simpler to show in code.</p>
<p>So, for the DE, we can actually use <code>linpred_draws</code> as before. We can look at age = 0 and age = 1 (a one unit change), BUT, let’s peg firesev to 0. Note, this is all fine for linear equations. Were we talking about nonlinear relationships, we’d likely want some context here - using medians or other intelligently chosen values.</p>
<p>Once we get the predicted richness, we can subtract one from the other. Note, it’s going to be the slope - -0.205 - but, again, think about the process here and what could happen in a more complex scenario.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>de <span class="ot">&lt;-</span> <span class="fu">linpred_draws</span>(rich_brms,</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">age =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">firesev =</span> <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.category <span class="sc">==</span> <span class="st">"rich"</span>) <span class="sc">|&gt;</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age, .draw, .linpred) <span class="sc">|&gt;</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(.draw) <span class="sc">|&gt;</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(age) <span class="sc">|&gt;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">de =</span> .linpred[<span class="dv">2</span>] <span class="sc">-</span> .linpred[<span class="dv">1</span>])</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># here it is!</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(de<span class="sc">$</span>de)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.2035853</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(de<span class="sc">$</span>de, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.11</span>, <span class="fl">0.5</span>, <span class="fl">0.89</span>, <span class="fl">0.95</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         5%         11%         50%         89%         95% 
-0.42306080 -0.36770232 -0.20641050 -0.03878914  0.02153846 </code></pre>
</div>
</div>
<p>So, yes, complex for a linear model. But perfect if this had been, say, exponential. We could have even looked at how much richness changes in units of standard deviations or whatnot.</p>
<p>What’s great is that, from the above, we also got the change in fireseverity from the simulation - ~ -2.65. So, we can apply the same workflow, and them compare the two effects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>ide <span class="ot">&lt;-</span> <span class="fu">linpred_draws</span>(rich_brms,</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">age =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="at">firesev =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="sc">-</span><span class="fl">2.65</span>))) <span class="sc">|&gt;</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.category <span class="sc">==</span> <span class="st">"rich"</span>) <span class="sc">|&gt;</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age, .draw, .linpred) <span class="sc">|&gt;</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(.draw) <span class="sc">|&gt;</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(age) <span class="sc">|&gt;</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">ide =</span> .linpred[<span class="dv">2</span>] <span class="sc">-</span> .linpred[<span class="dv">1</span>])</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>direct_indirect <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">direct =</span> de<span class="sc">$</span>de, <span class="at">indirect =</span> ide<span class="sc">$</span>ide) <span class="sc">|&gt;</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>())</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(direct_indirect,</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">y =</span> name, <span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_slabinterval</span>() <span class="sc">+</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">""</span>, <span class="at">x =</span> <span class="st">"change in richness"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/ide-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Wow. Really shows the difference in magnitude and how much stronger that indirect effect is here. And while we could have done a bunch of multiplication here, we’re answering a direct question that is <strong>very</strong> specific, which I like. How strong is the direct versus indirect effect of changing age by one unit.</p>
<section id="ropes" class="level3">
<h3 class="anchored" data-anchor-id="ropes">ROPEs</h3>
<p>Eyeballing is great here, but, what if we want some numbers to sink our teeth into. We’re not talking p-values but something equivalent. In a frequentist world, a p value for NHST of a parameter evaluates a point hypothesis asking what is the probability of obtaining our coefficient or more extreme coefficient given the data and precision if the true value of the coefficient had been 0. That’s a lot. And not what we want to know.</p>
<p>We want to know, given our data, what’s the probability of our coefficient being practically equivalent to 0. We know there’s a full posterior there. We’re not interested in a point hypothesis. We instead want to meld biological significance and statistical evidence. So, what’s a range of potential values that a given coefficient could be estimate as that are, for all intents and purposes, 0. For linear models, Kruschke (2018) suggests 0 ± 0.1 SD of Y. I.e., a one unit change in X evinces a 10% change in SD of Y. However you define this region of practical equivalence to 0, we can test it. So, how much of the posterior of the direct and indirect effect are within that range? Let’s find out.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>sdy <span class="ot">&lt;-</span> <span class="fu">sd</span>(keeley<span class="sc">$</span>rich)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co"># how much of the direct effect is in the ROPE?</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(de<span class="sc">$</span>de <span class="sc">&gt;</span> <span class="sc">-</span><span class="fl">0.1</span> <span class="sc">*</span> sdy <span class="sc">&amp;</span> de<span class="sc">$</span>de <span class="sc">&lt;</span> <span class="fl">0.1</span> <span class="sc">*</span> sdy)<span class="sc">/</span><span class="fu">length</span>(de<span class="sc">$</span>de)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># and the indirect effect</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(ide<span class="sc">$</span>ide <span class="sc">&gt;</span> <span class="sc">-</span><span class="fl">0.1</span> <span class="sc">*</span> sdy <span class="sc">&amp;</span> ide<span class="sc">$</span>ide <span class="sc">&lt;</span> <span class="fl">0.1</span> <span class="sc">*</span> sdy)<span class="sc">/</span><span class="fu">length</span>(ide<span class="sc">$</span>ide)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.022</code></pre>
</div>
</div>
<p>So, 100% of the direct effect is in the ROPE. 2% of the indirect. This suggests that we have a fully mediated model here.</p>
<p>Note, 10% might be a lot. It’s worth asking, is that the proper interval? The range of fire severity is from 1.2 to 9.2. Is it reasonable that a 1 year stand age change evincing a 1% change in fire severity should be considered a null effect? That’s a question of biology! And might not be appropriate to just use 0.1 * sdy blindly.</p>
<p>Note: <code>bayestestR</code> has a <code>rope()</code> function, although it can be tricky to use with multivariate models when you want to set custom ranges. Needs some work for these models, but, you might find it useful.</p>
</section>
<section id="comparing-models-to-test-mediation" class="level3">
<h3 class="anchored" data-anchor-id="comparing-models-to-test-mediation">Comparing Models to Test Mediation</h3>
<p>OK, so, we have this suggestion that our direct effect is not needed. In classical SEM, we’d compare the two models and see if the simpler model produces a covariance matrix not different from the more complex saturated one. What to do here? Well, we have options. First, let’s fit a model with no direct effect.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>rich_bf_indirect <span class="ot">&lt;-</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(rich <span class="sc">~</span> firesev) <span class="sc">+</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(firesev <span class="sc">~</span> age) <span class="sc">+</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_rescor</span>(<span class="cn">FALSE</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>rich_brms_indirect <span class="ot">&lt;-</span> <span class="fu">brm</span>(rich_bf_indirect,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> keeley,</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">file =</span> <span class="st">"fit_models/rich_brms_indirect.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can compare these in a number of ways. For predictive ability, we could use Leave One Out cross-validation, for example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(rich_brms, rich_brms_indirect)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Output of model 'rich_brms':

Computed from 4000 by 90 log-likelihood matrix.

         Estimate   SE
elpd_loo   -532.9  8.5
p_loo         6.6  1.0
looic      1065.9 16.9
------
MCSE of elpd_loo is 0.0.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.9, 1.5]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.

Output of model 'rich_brms_indirect':

Computed from 4000 by 90 log-likelihood matrix.

         Estimate   SE
elpd_loo   -533.2  8.6
p_loo         5.8  0.9
looic      1066.3 17.1
------
MCSE of elpd_loo is 0.0.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.9, 1.4]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.

Model comparisons:
                   elpd_diff se_diff
rich_brms           0.0       0.0   
rich_brms_indirect -0.2       1.2   </code></pre>
</div>
</div>
<p>They are not really different - within an SE of one another. We could use Bayes Factors, which give a weight of evidence of one model over another. They are approximated in the likelihood world with the BIC. You can use <code>bayes_factor()</code> or <code>bayestestR::bf()</code>. Here, we’re using flat priors, which is not great for BFs. Don’t do this. As this tutorial uses cmdstanr, to avoid recompiling, and all that, I’ll just give you the result of <code>bayes_factor()</code></p>
<pre><code>Estimated Bayes factor in favor of rich_brms over rich_brms_indirect: 1.09650</code></pre>
<p>So, that means there’s an even chance of one model versus the other - similar ot the loo output.</p>
<p>Given all of the evidence, we can likely reject the model with direct and indirect effects in favor of the simpler model.</p>
</section>
</section>
<section id="assessing-model-fit" class="level2">
<h2 class="anchored" data-anchor-id="assessing-model-fit">Assessing Model Fit</h2>
<p>One of the big things about SEM is the ability to look at global fit. Particularly covariance-based approaches are premised on looking at fit to observed covariance matrices. <code>piecewiseSEM</code> models are evaluated by looking at tests of directed separation.</p>
<p>Too look at this, let’s start with a new model with a hair more complexity so we can show tests of model fit. We’ll use <a href="https://allisonhorst.github.io/palmerpenguins/"><code>palmerpenguins</code></a> and have a model where species predicts mass which predicts morphological characteristics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(palmerpenguins)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>penguin_bf <span class="ot">&lt;-</span> </span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(body_mass_g <span class="sc">~</span> species) <span class="sc">+</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(flipper_length_mm <span class="sc">~</span> body_mass_g) <span class="sc">+</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(bill_length_mm <span class="sc">~</span> body_mass_g) <span class="sc">+</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_rescor</span>(<span class="cn">FALSE</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>penguin_sparse_brm <span class="ot">&lt;-</span> <span class="fu">brm</span>(penguin_bf,</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> penguins,</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>                          <span class="at">file =</span> <span class="st">"fit_models/penguin_sparse_brm.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The model runs, but, is it any good? Or are there things missing? How can we evaluate global fit? We have a few options</p>
<section id="fit-of-response-variables" class="level3">
<h3 class="anchored" data-anchor-id="fit-of-response-variables">Fit of response variables</h3>
<p>How did we do here? Are our models any good at representing the data generating processes that lead to the endogenous variables? In Bayesian models, we often look at posterior checks to see whether the distribution of the model matches the data. We can do this with <code>pp_check()</code>. Note, in specifying which response variable, <code>brms</code> likes to ditch underscores. You can see this with <code>variables(penguin_sparse_brm)</code> to see coefficient names and variable names.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(penguin_sparse_brm, </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">resp =</span> <span class="st">"bodymassg"</span>) <span class="sc">+</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"body mass g"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using 10 posterior draws for ppc type 'dens_overlay' by default.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/pp_check-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(penguin_sparse_brm, </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">resp =</span> <span class="st">"billlengthmm"</span>)<span class="sc">+</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"bill length"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using 10 posterior draws for ppc type 'dens_overlay' by default.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/pp_check-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(penguin_sparse_brm, </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">resp =</span> <span class="st">"flipperlengthmm"</span>)<span class="sc">+</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"flipper length"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using 10 posterior draws for ppc type 'dens_overlay' by default.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/pp_check-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Body mass looks good, but, both flipper length and bill length have something…. off. BTW, to see them all in one place, we can use some magic from <code>patchwork::wrap_plots()</code> to bring it all together for a model of arbitrary size.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>penguin_bf<span class="sc">$</span>responses <span class="sc">|&gt;</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="sc">~</span><span class="fu">pp_check</span>(penguin_sparse_brm, </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">resp =</span> .x) <span class="sc">+</span> </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>               <span class="fu">labs</span>(<span class="at">title =</span> .x)) <span class="sc">|&gt;</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">wrap_plots</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/magic_pp_check-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>It’s the multimodality that is problematic here in the observed v. predicted data. Note that the predictions for body mass HAVE that multimodality. Species is also a predictor. Which suggests…. yeah, you guessed it.</p>
<p>But, this approach is a <em>great</em> way of assessing model fit in general. It won’t tell you what is wrong, but it will tell you what is not working as a visual assessment of fit. You can also look at other plots other than the posterior density overlay - I’m a fan of loo plots such as the following (which show the same problems)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>penguin_bf<span class="sc">$</span>responses <span class="sc">|&gt;</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="sc">~</span><span class="fu">pp_check</span>(penguin_sparse_brm, </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">resp =</span> .x, <span class="at">type =</span> <span class="st">"loo_intervals"</span>) <span class="sc">+</span> </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>               <span class="fu">labs</span>(<span class="at">title =</span> .x)) <span class="sc">|&gt;</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">wrap_plots</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/loo_plots-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>penguin_bf<span class="sc">$</span>responses <span class="sc">|&gt;</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="sc">~</span><span class="fu">pp_check</span>(penguin_sparse_brm, </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">resp =</span> .x, <span class="at">type =</span> <span class="st">"loo_pit_overlay"</span>) <span class="sc">+</span> </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>               <span class="fu">labs</span>(<span class="at">title =</span> .x)) <span class="sc">|&gt;</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">wrap_plots</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/loo_plots-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conditional-independence-tests" class="level3">
<h3 class="anchored" data-anchor-id="conditional-independence-tests">Conditional Independence Tests</h3>
<p>What about tests of conditional independence? This has been a hallmark of piecewise approaches, and is a great way to evaluate hard causal claims about the structure of a model - namely, that two variables do not connect?</p>
<p>First, what are the claims? Let’s use some tools from ‘dagitty’ and ‘ggdag’ here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dagify</span>(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  body_mass_g <span class="sc">~</span> species ,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  flipper_length_mm <span class="sc">~</span> body_mass_g, </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  bill_length_mm <span class="sc">~</span> body_mass_g </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">impliedConditionalIndependencies</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>bl__ _||_ fl__ | bd__
bl__ _||_ spcs | bd__
fl__ _||_ spcs | bd__</code></pre>
</div>
</div>
<p>Shortened names together, we can see there are three claims - each of which we should be able to evaluate here. So, how do we do this evaluation?</p>
<p><strong>Brutal honesty time - I’m still thinking a lot about the right way to do this, and would love any thoughts and feedback on some of the next few bits. Some parts, I will even phrase as a question with some uncertainty. Greater Bayesian minds than I (I still am a dabbler after all) might have some great thoughts here</strong></p>
<p>In evaluating conditional independence, we have a straightforward relationship. Let’s say we wanted to know the conditional indepdence of bl <em>||</em> sp | bm. Well, we know that this implies</p>
<p>p(bl | sp, bm) = p(bl | bm)</p>
<p>What’s the evidence for this claim? On it’s face it seems like, well, let’s fit a model with a missing link included, and then look at the posterior of that coefficient and see if it overlaps 0. That makes me uncomfortable for two reasons. First, that’s awfully frequentist, TBH. I know, we could use ROPEs as an alternative. But, that doesn’t resolve the second issue. Namely, what about non-continuous variables? How do we evaluate it for incorporating a categorical variable with three levels? Do we look at each level of the categorical variable independently? That’s not right.</p>
<p>So, what’s a more general solution? I have two thoughts here, both resting on distributional overlaps. <strong>I’d love to know if these all seem reasonable or incorrect or if I’m missing something obvious</strong></p>
<p>First, we have the relationship fl <em>||</em> sp | bm</p>
<p>p(fl | sp, bm) = p(fl | bm)</p>
<p>We could look at the distributional overlap of predictions from a model with and without a predictor included. If the overlap is high, then we have a conditional independence relationship. If low, we likely do not.</p>
<p>I can think of three ways to do this - one with the data we have - so, compare the posterior of a fitted values from two models. Let’s look at a test of p(fl <em>||</em> sp | bm).</p>
<p>First, let’s fit the model where we relax the conditional independence claim.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First, fit the model.</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>penguin_flipper_species_bf <span class="ot">&lt;-</span> </span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(body_mass_g <span class="sc">~</span> species) <span class="sc">+</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(flipper_length_mm <span class="sc">~</span> body_mass_g <span class="sc">+</span> species) <span class="sc">+</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(bill_length_mm <span class="sc">~</span> body_mass_g) <span class="sc">+</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_rescor</span>(<span class="cn">FALSE</span>)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>penguin_flipper_species_brm <span class="ot">&lt;-</span> </span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(penguin_flipper_species_bf,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> penguins,</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">file =</span> <span class="st">"fit_models/penguin_flipper_species_brm.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let’s compare the posterior of flipper lengths with and without species using <code>bayestestR::overlap()</code> to compare the overlap of two distributions and plot it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>sparse_post <span class="ot">&lt;-</span> </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linpred_draws</span>(penguin_sparse_brm,</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">newdata =</span> penguins) <span class="sc">|&gt;</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(.category <span class="sc">==</span> <span class="st">"flipperlengthmm"</span>) <span class="sc">|&gt;</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mod =</span> <span class="st">"sparse"</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>flipper_post <span class="ot">&lt;-</span> </span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linpred_draws</span>(penguin_flipper_species_brm,</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">newdata =</span> penguins) <span class="sc">|&gt;</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(.category <span class="sc">==</span> <span class="st">"flipperlengthmm"</span>) <span class="sc">|&gt;</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mod =</span> <span class="st">"flipper_species"</span>)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>bayestestR<span class="sc">::</span><span class="fu">overlap</span>(sparse_post<span class="sc">$</span>.linpred,</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>                      flipper_post<span class="sc">$</span>.linpred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Overlap

73.8%</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">bind_rows</span>(sparse_post, flipper_post),</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> .linpred, <span class="at">fill =</span> mod)) <span class="sc">+</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="co">#+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 16000 rows containing non-finite outside the scale range
(`stat_density()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/test_fl_sp_bm-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_density(data = penguins, </span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#              aes(x = flipper_length_mm),</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#              linewidth = 3, fill = NA) +</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># labs(subtitle = "predicted flipper with actual data as thick line")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So, p(fl <em>||</em> sp | bm) = 74%? And we can see there’s a big area predicted by the sparse model that is not predicted by the flipper_species model. Which, looking back at the posterior checks before, we see this new model better matches the data. Taken together, yeah, we can see that flipper length is not conditionally independent of species.</p>
<p>But, what if the values of the predictors somehow biases the overlap? Better then to take a single value or a grid of values in the case of nonlinear or categorical relationships to test against. With a continuous variable and a linear relationship we can just plug in one number for the more saturated model to make the test. For categorical variables, we can test all levels while holding the other predictors constant and then look at overlap in posterior predictions. This is a great job for <code>emmeans</code> (or <code>marginaleffects</code>, although I haven’t worked with it much). We can get those predictions, and then look at the posteriors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we use 1 as species is not in the </span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="co"># relationship of interest</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>sparse_em <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(penguin_sparse_brm, </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">specs =</span> <span class="sc">~</span><span class="dv">1</span>, </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">resp =</span> <span class="st">"flipperlengthmm"</span>) </span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>sparse_em_posterior <span class="ot">&lt;-</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather_emmeans_draws</span>(sparse_em) <span class="sc">|&gt;</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mod =</span> <span class="st">"sparse"</span>)</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>flipper_sp_em <span class="ot">&lt;-</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">emmeans</span>(penguin_flipper_species_brm, </span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>                      <span class="at">specs =</span> <span class="sc">~</span>species, </span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>                      <span class="at">resp =</span> <span class="st">"flipperlengthmm"</span>) </span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>flipper_sp_em_posterior <span class="ot">&lt;-</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather_emmeans_draws</span>(flipper_sp_em) <span class="sc">|&gt;</span></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mod =</span> <span class="st">"flipper_sp"</span>)</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">bind_rows</span>(flipper_sp_em_posterior,</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>                 sparse_em_posterior),</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> .value, <span class="at">fill =</span> mod)) <span class="sc">+</span></span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>bayestestR<span class="sc">::</span><span class="fu">overlap</span>(sparse_em_posterior<span class="sc">$</span>.value,</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>                    flipper_sp_em_posterior<span class="sc">$</span>.value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Overlap

11.7%</code></pre>
</div>
</div>
<p>MUCH less overlap here. And more clarity for a single value here.</p>
<p>There’s still something bothering me, though. Namely, interactions and nonlinearities. Now, one way could be to do something like the above, but for a range of values of continuous covariates to capture the entire space of that nonlinearity. But, hrmph. I’m not sure.</p>
<p>So, is there something more general than looking at predicted values? Would it be simpler - and more one-size fits all - to look at the overlap of the log posteriors? I wonder if this is an answer. I realize this gets close to Bayes Factors in a way, but, conceptually, there’s something I prefer about overlap here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>bayestestR<span class="sc">::</span><span class="fu">overlap</span>(  <span class="fu">log_posterior</span>(penguin_flipper_species_brm)<span class="sc">$</span>Value, </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">log_posterior</span>(penguin_sparse_brm)<span class="sc">$</span>Value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Overlap

0.0%</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>posts <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log_posterior</span>(penguin_flipper_species_brm) <span class="sc">|&gt;</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">mod =</span> <span class="st">"flipper_species"</span>),</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log_posterior</span>(penguin_sparse_brm) <span class="sc">|&gt;</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">mod =</span> <span class="st">"original"</span>)) </span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(posts, <span class="fu">aes</span>(<span class="at">x =</span> Value, </span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> mod)) <span class="sc">+</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/overlap_log_posterior-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>I mean, wow, these are really different. I have not worked enough with log posteriors to say whether I think this is correct or not……but intuitively it seems correct. Although the degree of lack of is real real large. So……. Maybe not?</p>
</section>
<section id="comparison-against-a-saturated-model" class="level3">
<h3 class="anchored" data-anchor-id="comparison-against-a-saturated-model">Comparison Against a Saturated Model</h3>
<p>To an old school SEM-er, none of the above is really OMNIBUS. Like, we’re not getting a single value for a whole model, or testing a fully saturated versus our reduced model. To which I say - uh, ok. But the above checks are doing all we wanted that single number to do, but in a far more nuanced way. Personally, I really like it.</p>
<p>But there is something satisfying about comparing to a saturated model. The important thing is to think about, what is the question you are trying to ask by doing so? Let’s fit a saturated model and ask two questions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>penguin_bf_saturated <span class="ot">&lt;-</span> </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(body_mass_g <span class="sc">~</span> species) <span class="sc">+</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(flipper_length_mm <span class="sc">~</span> body_mass_g <span class="sc">+</span> species) <span class="sc">+</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(bill_length_mm <span class="sc">~</span> body_mass_g <span class="sc">+</span> species <span class="sc">+</span> flipper_length_mm) <span class="sc">+</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_rescor</span>(<span class="cn">FALSE</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>penguin_saturated_brm <span class="ot">&lt;-</span> <span class="fu">brm</span>(penguin_bf_saturated,</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> penguins,</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>                             <span class="at">file =</span> <span class="st">"fit_models/penguin_saturated_brm.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note, we chose one direction of the bill -&gt; flipper relationship here. Others are possible. You could even have them have correlated errors. I’ll talk about how to include correlated residuals below.</p>
</section>
<section id="how-does-a-saturated-model-do-vis-a-vis-posterior-prediction-of-our-data" class="level3">
<h3 class="anchored" data-anchor-id="how-does-a-saturated-model-do-vis-a-vis-posterior-prediction-of-our-data">How does a saturated model do vis a vis posterior prediction of our data?</h3>
<p>We can recycle our code from before and look at posterior predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>penguin_bf<span class="sc">$</span>responses <span class="sc">|&gt;</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="sc">~</span><span class="fu">pp_check</span>(penguin_saturated_brm, </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">resp =</span> .x) <span class="sc">+</span> </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>               <span class="fu">labs</span>(<span class="at">title =</span> .x)) <span class="sc">|&gt;</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">wrap_plots</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using 10 posterior draws for ppc type 'dens_overlay' by default.
Using 10 posterior draws for ppc type 'dens_overlay' by default.
Using 10 posterior draws for ppc type 'dens_overlay' by default.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/post_saturated-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Damn. That looks good. Honestly, in a comparison between that and the sparse model earlier, do we even need numbers to think about which model is better?</p>
</section>
<section id="how-good-is-a-saturated-model-at-out-of-sample-prediction-versus-our-sparse-model" class="level3">
<h3 class="anchored" data-anchor-id="how-good-is-a-saturated-model-at-out-of-sample-prediction-versus-our-sparse-model">How good is a saturated model at out of sample prediction versus our sparse model?</h3>
<p>If we want to know about out of sample prediction and do model comparison/cross validation, we can use WAIC or LOOCV here. Those tools are very well developed, and I’ll refer you to <a href="https://www.bayesrulesbook.com/chapter-10#chapter-10-train-test">better sources</a> on Bayesian CV and LOO. But, here it is.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(penguin_sparse_brm,</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>           penguin_saturated_brm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Output of model 'penguin_sparse_brm':

Computed from 4000 by 342 log-likelihood matrix.

         Estimate   SE
elpd_loo  -4728.0 23.7
p_loo         9.2  0.6
looic      9456.1 47.4
------
MCSE of elpd_loo is 0.1.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.8, 1.1]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.

Output of model 'penguin_saturated_brm':

Computed from 4000 by 342 log-likelihood matrix.

         Estimate   SE
elpd_loo  -4432.8 25.7
p_loo        15.6  1.7
looic      8865.6 51.4
------
MCSE of elpd_loo is 0.1.
MCSE and ESS estimates assume MCMC draws (r_eff in [0.7, 1.4]).

All Pareto k estimates are good (k &lt; 0.7).
See help('pareto-k-diagnostic') for details.

Model comparisons:
                      elpd_diff se_diff
penguin_saturated_brm    0.0       0.0 
penguin_sparse_brm    -295.2      20.8 </code></pre>
</div>
</div>
<p>Yes. The saturated model is way better at predicting out of sample.</p>
</section>
<section id="what-are-the-odds-of-one-model-versus-the-other" class="level3">
<h3 class="anchored" data-anchor-id="what-are-the-odds-of-one-model-versus-the-other">What are the odds of one model versus the other?</h3>
<p>Again, we can compare models using Bayes Factors. Again, make sure you know what you’re doing. Note, this is not appropriate with the flat priors we have, but…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bayes_factor</span>(penguin_sparse_brm,</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>             penguin_saturated_brm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running /Library/Frameworks/R.framework/Resources/bin/R CMD SHLIB foo.c
using C compiler: ‘Apple clang version 16.0.0 (clang-1600.0.26.6)’
using SDK: ‘MacOSX15.0.sdk’
clang -arch arm64 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG   -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/Rcpp/include/"  -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/RcppEigen/include/"  -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/RcppEigen/include/unsupported"  -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/BH/include" -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/StanHeaders/include/src/"  -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/StanHeaders/include/"  -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/RcppParallel/include/"  -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/rstan/include" -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DUSE_STANC3 -DSTRICT_R_HEADERS  -DBOOST_PHOENIX_NO_VARIADIC_EXPRESSION  -D_HAS_AUTO_PTR_ETC=0  -include '/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/StanHeaders/include/stan/math/prim/fun/Eigen.hpp'  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/opt/R/arm64/include    -fPIC  -falign-functions=64 -Wall -g -O2  -c foo.c -o foo.o
In file included from &lt;built-in&gt;:1:
In file included from /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/StanHeaders/include/stan/math/prim/fun/Eigen.hpp:22:
In file included from /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/RcppEigen/include/Eigen/Dense:1:
In file included from /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/RcppEigen/include/Eigen/Core:19:
/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/RcppEigen/include/Eigen/src/Core/util/Macros.h:679:10: fatal error: 'cmath' file not found
  679 | #include &lt;cmath&gt;
      |          ^~~~~~~
1 error generated.
make: *** [foo.o] Error 1</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Iteration: 1
Iteration: 2
Iteration: 3
Iteration: 4
Iteration: 5
Iteration: 6
Iteration: 7
Iteration: 8
Iteration: 9</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running /Library/Frameworks/R.framework/Resources/bin/R CMD SHLIB foo.c
using C compiler: ‘Apple clang version 16.0.0 (clang-1600.0.26.6)’
using SDK: ‘MacOSX15.0.sdk’
clang -arch arm64 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG   -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/Rcpp/include/"  -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/RcppEigen/include/"  -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/RcppEigen/include/unsupported"  -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/BH/include" -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/StanHeaders/include/src/"  -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/StanHeaders/include/"  -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/RcppParallel/include/"  -I"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/rstan/include" -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DUSE_STANC3 -DSTRICT_R_HEADERS  -DBOOST_PHOENIX_NO_VARIADIC_EXPRESSION  -D_HAS_AUTO_PTR_ETC=0  -include '/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/StanHeaders/include/stan/math/prim/fun/Eigen.hpp'  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/opt/R/arm64/include    -fPIC  -falign-functions=64 -Wall -g -O2  -c foo.c -o foo.o
In file included from &lt;built-in&gt;:1:
In file included from /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/StanHeaders/include/stan/math/prim/fun/Eigen.hpp:22:
In file included from /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/RcppEigen/include/Eigen/Dense:1:
In file included from /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/RcppEigen/include/Eigen/Core:19:
/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library/RcppEigen/include/Eigen/src/Core/util/Macros.h:679:10: fatal error: 'cmath' file not found
  679 | #include &lt;cmath&gt;
      |          ^~~~~~~
1 error generated.
make: *** [foo.o] Error 1</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Iteration: 1
Iteration: 2
Iteration: 3
Iteration: 4
Iteration: 5
Iteration: 6
Iteration: 7
Iteration: 8
Iteration: 9
Iteration: 10
Iteration: 11
Iteration: 12
Iteration: 13
Iteration: 14
Iteration: 15</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Estimated Bayes factor in favor of penguin_sparse_brm over penguin_saturated_brm: 0.00000</code></pre>
</div>
</div>
<p>Well that’s clear.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dagify</span>(</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  body_mass_g <span class="sc">~</span> species ,</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  flipper_length_mm <span class="sc">~</span> body_mass_g, </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  bill_length_mm <span class="sc">~</span> body_mass_g </span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">impliedConditionalIndependencies</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>bl__ _||_ fl__ | bd__
bl__ _||_ spcs | bd__
fl__ _||_ spcs | bd__</code></pre>
</div>
</div>
<p>We can then test each relationship sequentially to evaluate the independence claim. Note, I suggest this as it is possible when including some links in a saturated model that it might alter the estimation of other parameters depending on model structure. In this case, it actually does not make a difference, so, we can look at each relationship based on the saturated model.</p>
</section>
</section>
<section id="the-power-of-priors" class="level2">
<h2 class="anchored" data-anchor-id="the-power-of-priors">The Power of Priors</h2>
<p>When Bayesian methods make their way into a new discipline, folk within that discipline - typically rooted in the frequentist ways they’ve thought of for ages - tend to freak out. Why? Priors. It seems like putting your tumb on the scale to get the result that you want. This seems like bad practice.</p>
<p>In truth, priors are some of the power behind the Bayesian throne. First off, let’s deal with the ‘thumb on the scale’ thing. What? You’re not going to do a robustness analysis? If you have n=3, you’re not going to talk about the influence of your prior? Come on, that’s just bad science. I could go on about other objections, but it’s all rather overblown.</p>
<p>But, what’s the power of a prior? A few things. First, when we fit models with least squares and likelihood by default we assume any parameter can take any value. That’s a ‘flat prior’. And that’s silly. You really think that as a penguin increases in body mass, it won’t increase in size in other dimensions as well? As a child gets older, it’s possible it will shrink? While this seems trivial, priors that acknowledge basic strictures of biology of physics can reduce the area searched, increase our precision in estimation, and allow us to learn things with a smaller sample size than in a frequentist world.</p>
<p>Further, if we want to start out with a null expectation and really make the data work to overcome it, we can impose regularizing priors. Weakly regularlizing priors can indeed make a model behave fairly well as it reduces the possibility of crazy extreme values.</p>
<p>These are really neat technical things. But, what I enjoy the most is that we can simulate from our priors. Create a model, don’t give it any data, and you can <em>still</em> simulate data. Not only that, but, you can then inspect your prior simulations to see if what you have setup is reasonable. Do you predict crazy values? Do you have curves that go opposite to basic restrictions of biology? Do you see that your error distributions you’ve chosen, before you even do anything, are probably wrong. Mazel! Your priors have just saved you some BIG headaches that you would have run into.</p>
<p>Let’s take a look at simulating from priors with the keeley fire severity example. Where we last left this model, we determined that we had a chain leading from age to richness: age -&gt; firesev -&gt; rich</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>rich_indirect_bf <span class="ot">&lt;-</span> </span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(rich <span class="sc">~</span> firesev) <span class="sc">+</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(firesev <span class="sc">~</span> age) <span class="sc">+</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_rescor</span>(<span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, what are our default priors?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_prior</span>(rich_indirect_bf, <span class="at">data =</span> keeley)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  prior     class    coef group    resp dpar nlpar lb ub
                 (flat)         b                                       
                 (flat) Intercept                                       
                 (flat)         b               firesev                 
                 (flat)         b     age       firesev                 
 student_t(3, 4.3, 2.5) Intercept               firesev                 
   student_t(3, 0, 2.5)     sigma               firesev             0   
                 (flat)         b                  rich                 
                 (flat)         b firesev          rich                 
 student_t(3, 50, 19.3) Intercept                  rich                 
  student_t(3, 0, 19.3)     sigma                  rich             0   
       source
      default
      default
      default
 (vectorized)
      default
      default
      default
 (vectorized)
      default
      default</code></pre>
</div>
</div>
<p>Wild. We see that the betas are all flat. The sigmas and intercepts have been chosen with some respect to the data, and our sigmas have a lower bound of zero.</p>
<p>So, what <em>should</em> our priors for slopes and intercepts be? I like to look at the ranges of my data to think about that. Let’s start with the age -&gt; fire severity relationship.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(keeley<span class="sc">$</span>age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  3 60</code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(keeley<span class="sc">$</span>firesev)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.2 9.2</code></pre>
</div>
</div>
<p>OK. So. We want to not predict things much much bigger than 9 or less than 2 with values that are from 3 to 60. I mean, we can - but, this is the range of reasonability in our data. I like to think of a line here and good ole change in y over change in x - (9.2-1.2)/(60-3) gives a slope of -0.14. So, if we think of a slope that’s likely between -0.14 and 0.14, we can start to think of an intelligent prior here - perhaps a normal with a mean of 0 and sd of 0.08.</p>
<p>We can do the same for richness</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>(<span class="fu">range</span>(keeley<span class="sc">$</span>rich)[<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">range</span>(keeley<span class="sc">$</span>rich)[<span class="dv">2</span>])<span class="sc">/</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  (<span class="fu">range</span>(keeley<span class="sc">$</span>firesev)[<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">range</span>(keeley<span class="sc">$</span>firesev)[<span class="dv">2</span>]) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8.75</code></pre>
</div>
</div>
<p>So, normal(0, 5).</p>
<p>We could widen things a bit or narrow them. Note, this is for linear predictors. Of course things can get more interesting for nonlinear relationships.</p>
<p>Let’s set those priors (we’ll keep the intercepts for now) and then generate a model with priors only. It will then sample from those priors to get chains for use by other methods later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>rich_indirect_prior <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">0.08</span>), <span class="at">class =</span> <span class="st">"b"</span>, </span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">coef =</span> <span class="st">"age"</span>, <span class="at">resp =</span> <span class="st">"firesev"</span>),</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="at">class =</span> <span class="st">"b"</span>, </span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">coef =</span> <span class="st">"firesev"</span>, <span class="at">resp =</span> <span class="st">"rich"</span>)</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="co"># fit a model with priors only</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>rich_indirect_prioronly <span class="ot">&lt;-</span> <span class="fu">brm</span>(rich_indirect_bf,</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>                         <span class="at">prior =</span> rich_indirect_prior,</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> keeley,</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>                         <span class="at">sample_prior =</span> <span class="st">"only"</span>,</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>                         <span class="at">file =</span> <span class="st">"fit_models/rich_indirect_prioronly.rds"</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>                         )</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(rich_indirect_prioronly)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: MV(gaussian, gaussian) 
  Links: mu = identity; sigma = identity
         mu = identity; sigma = identity 
Formula: rich ~ firesev 
         firesev ~ age 
   Data: keeley (Number of observations: 90) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Regression Coefficients:
                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
rich_Intercept       50.89     41.24   -25.19   125.99 1.00     3709     2070
firesev_Intercept     4.25      4.35    -4.11    12.75 1.00     3843     2199
rich_firesev          0.00      5.05    -9.79     9.81 1.00     5564     3067
firesev_age           0.00      0.08    -0.15     0.16 1.00     5132     2784

Further Distributional Parameters:
              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma_rich       22.18     34.81     0.69    80.01 1.00     4229     2303
sigma_firesev     2.75      3.10     0.09    10.15 1.00     4202     2015

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Neat! Now we can use this to sumulate the implications of our priors. Let’s get, say, 500 runs - first just for fire severity using those endmembers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>firesev_prior_sim <span class="ot">&lt;-</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">linpred_draws</span>(rich_indirect_prioronly,</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">age =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">60</span>),</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">firesev =</span> <span class="cn">NA</span>),</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">ndraws =</span> <span class="dv">500</span>) <span class="sc">|&gt;</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.category <span class="sc">==</span> <span class="st">"firesev"</span>)</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> firesev_prior_sim,</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> .linpred, <span class="at">group =</span> .draw)) <span class="sc">+</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span> </span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"fire severity"</span>, <span class="at">title =</span> <span class="st">"from prior"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/sim_firesev-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Not bad in terms of staying in the bounds of reality. Are there some bad lines there? Sure. But not many. We can also see that our prior is regularizing towards 0. But a large range is possible here. Now, we <em>might</em> want to tighten things in here - there’s an awful lot of fire severity above 10 and some below 0. But, for the moment, this isn’t that bad.</p>
<p>For fun, let’s overlay the actual data on this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> firesev_prior_sim,</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> .linpred)) <span class="sc">+</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="fu">aes</span>(<span class="at">group =</span> .draw)) <span class="sc">+</span> </span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> keeley, </span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> firesev), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"fire severity"</span>, <span class="at">title =</span> <span class="st">"from prior"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Not terrible! It argues again for tightening up that sd, but, meh, let’s run with it. In fact, let’s see how it translates over to richness.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>rich_prior_sim <span class="ot">&lt;-</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">linpred_draws</span>(rich_indirect_prioronly,</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">newdata =</span> firesev_prior_sim <span class="sc">|&gt;</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">filter</span>(.draw <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">firesev =</span> .linpred) <span class="sc">|&gt;</span> </span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">select</span>(age, firesev),</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">ndraws =</span> <span class="dv">500</span>) <span class="sc">|&gt;</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.category <span class="sc">==</span> <span class="st">"rich"</span>)</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> rich_prior_sim,</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> firesev, <span class="at">y =</span> .linpred)) <span class="sc">+</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="fu">aes</span>(<span class="at">group =</span> .draw)) <span class="sc">+</span> </span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> keeley, </span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> rich), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"richness"</span>, <span class="at">title =</span> <span class="st">"from prior"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/prior_rich-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Whew - again, some wild values, some due to negative fire severity, and more. We also have richness values of &gt; 100, which seems not great. Let’s look at this with respect to age instead.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> rich_prior_sim,</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> .linpred)) <span class="sc">+</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.05</span>, <span class="fu">aes</span>(<span class="at">group =</span> .draw)) <span class="sc">+</span> </span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> keeley, </span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">y =</span> rich), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"richness"</span>, <span class="at">title =</span> <span class="st">"from prior"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>That’s not bad! Now, if we wanted to tighten things up, we have a few options. First, we could reduce the SD on both of our priors. Second, we could instead do all of this on a z-scored scale.</p>
<p>Wait, why? Well, z-transforming our variables can do a few nice things. It can speed up fitting in difficult cases. It also means that there are some fairly standard priors we can use. There’s a lot written on prior choice. I’m fond of <a href="https://github.com/stan-dev/stan/wiki/prior-choice-recommendations">this wiki</a> as well as <a href="https://nsojournals.onlinelibrary.wiley.com/doi/full/10.1111/oik.05985">this piece</a> by Nathan Lemoine. These work well on a z-transformed scale, regardless of initial values of your data (generally - as with all things Bayesian model, ymmv, and check yourself before you wreck yourself).</p>
<p>All of this done, let’s look at our model with with priors!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>rich_indirect_withpriors <span class="ot">&lt;-</span> <span class="fu">brm</span>(rich_indirect_bf,</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">prior =</span> rich_indirect_prior,</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> keeley,</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">file =</span> <span class="st">"fit_models/rich_indirect_withpriors.rds"</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>                         )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, did this make a huge difference? As we have a pretty robust data set, we’d expect not, but, let’s look</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(rich_brms_indirect, <span class="at">effects =</span> <span class="st">"fixed"</span>) <span class="sc">|&gt;</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"firesev"</span>, <span class="st">"age"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 8
  response effect component term    estimate std.error conf.low conf.high
  &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;     &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 rich     fixed  cond      firesev  -3.36      0.923   -5.15     -1.53  
2 firesev  fixed  cond      age       0.0597    0.0131   0.0341    0.0850</code></pre>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(rich_indirect_withpriors, <span class="at">effects =</span> <span class="st">"fixed"</span>) <span class="sc">|&gt;</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(term <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"firesev"</span>, <span class="st">"age"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 8
  response effect component term    estimate std.error conf.low conf.high
  &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;     &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 rich     fixed  cond      firesev  -3.25      0.915   -5.07     -1.46  
2 firesev  fixed  cond      age       0.0582    0.0126   0.0335    0.0819</code></pre>
</div>
</div>
<p>The difference is not monumental. Some shrinkage and some increased precision - which we’d expect. But, honestly, the data overwhelms the prior here, so, not bad. In a more complex model with a lower sample size, this might be more important for increased precision.</p>
<p>But, still, I’d argue the ability to simulate from the get-go to begin to understand our theory and how the effect of age propogated through the entire system - that’s the real power here.</p>
</section>
<section id="correlated-error" class="level2">
<h2 class="anchored" data-anchor-id="correlated-error">Correlated Error</h2>
<p>There are a few other features of SEMs that researchers might want to use. One fairly common one is correlated error. The error of two variables can be correlated for a number of reasons. Perhaps one is derived from the other, as in the case of a nonlinear transformed variable. There is no causal connection, but still correlated error. Perhaps they are driven by a common cause that is not included in the model. Perhaps there is high uncertainty in the directionality of causality, and you wish to be careful and control for the correlation, but not specify a direction hypothesis. Perhaps there is a physical constraint causing the two variables to be related.</p>
<p>Either way, these can be modeled. To go back to the <code>palmerpenguins</code> data, perhaps we are interested in a model regarding how species and body mass affect both bill length and height. Length and height, as they’re both representitive of ‘bill size’ will be correlated. However, it’s due to a physical constraint - as a bill gets longer it also gets deeper. It’s not a causal relationship.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dagify</span>(bill_length_mm <span class="sc">~</span> species <span class="sc">+</span> body_mass_g,</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>       bill_depth_mm <span class="sc">~</span> species <span class="sc">+</span> body_mass_g,</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>       bill_length_mm <span class="sc">~</span><span class="er">~</span> bill_depth_mm,</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">coords =</span> <span class="fu">tribble</span>(</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>         <span class="sc">~</span>x, <span class="sc">~</span>y, <span class="sc">~</span>name,</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>         <span class="dv">0</span>,   <span class="dv">0</span>,  <span class="st">"species"</span>,</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>         <span class="dv">0</span>,   <span class="dv">1</span>,  <span class="st">"body_mass_g"</span>,</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>         <span class="dv">1</span>,   <span class="dv">0</span>,  <span class="st">"bill_depth_mm"</span>,</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>         <span class="dv">1</span>,   <span class="dv">1</span>,  <span class="st">"bill_length_mm"</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>       ) ) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/corr_err_dag-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We could have gotten fancier and included the error of both and had those be the correlation - but same meaning</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># need to figure out hot to put circles around e variables</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dagify</span>(bill_length_mm <span class="sc">~</span> species <span class="sc">+</span> body_mass_g <span class="sc">+</span> e_length,</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>       bill_depth_mm <span class="sc">~</span> species <span class="sc">+</span> body_mass_g <span class="sc">+</span> e_depth,</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>       e_length <span class="sc">~</span><span class="er">~</span> e_depth,</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">coords =</span> <span class="fu">tribble</span>(</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>         <span class="sc">~</span>x, <span class="sc">~</span>y, <span class="sc">~</span>name,</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>         <span class="dv">0</span>,   <span class="dv">0</span>,  <span class="st">"species"</span>,</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>         <span class="dv">0</span>,   <span class="dv">1</span>,  <span class="st">"body_mass_g"</span>,</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>         <span class="dv">1</span>,   <span class="dv">0</span>,  <span class="st">"bill_depth_mm"</span>,</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>         <span class="dv">1</span>,   <span class="dv">1</span>,  <span class="st">"bill_length_mm"</span>,</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>         <span class="dv">2</span>,   <span class="dv">0</span>,  <span class="st">"e_depth"</span>,</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>         <span class="dv">2</span>,   <span class="dv">1</span>,  <span class="st">"e_length"</span>         </span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>       ) ) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/corr_err_dag_errors-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So, how do we incorporate this correlated error into our model? <code>brms</code> has a nice syntactic solution. As error is modeled with each row getting its own residual value, we can formally write that into our model. This will look like a random effect (I mean, we’re modeling sigma). Further, <code>brms</code> has a synatax to allow random effects to be correlated across different relationships - i.e., correlated error! If we gave penguins a column called <code>obs</code> for observation number, then each component of the SEM from the above model would have <code>(1 | dl | obs)</code> in it, where <code>dl</code> here specifies a correlated set of errors - in our case, between depth and length (I could have called it anything). Last, we need to give each <code>bf()</code> a fixed sigma of 1. It’s a bit of an accounting trick so everything sloshes into the correlated errors, but, we need it to make an identified model.</p>
<p>Here’s what that model would look like. Note, I’m not going to work with priors in order to focus on the error structure. I leave that as an exercise for you.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>penguins <span class="ot">&lt;-</span> <span class="fu">mutate</span>(penguins, <span class="at">obs =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>cor_err_bf <span class="ot">&lt;-</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(bill_depth_mm <span class="sc">~</span> species <span class="sc">+</span> body_mass_g <span class="sc">+</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>       (<span class="dv">1</span><span class="sc">|</span>dl<span class="sc">|</span>obs), <span class="at">sigma =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(bill_length_mm <span class="sc">~</span> species <span class="sc">+</span> body_mass_g <span class="sc">+</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>       (<span class="dv">1</span><span class="sc">|</span>dl<span class="sc">|</span>obs), <span class="at">sigma =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_rescor</span>(<span class="cn">FALSE</span>)</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>corr_err_brm <span class="ot">&lt;-</span> <span class="fu">brm</span>(cor_err_bf,</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> penguins,</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">file =</span> <span class="st">"fit_models/corr_err_brm.rds"</span>)</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(corr_err_brm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: MV(gaussian, gaussian) 
  Links: mu = identity; sigma = identity
         mu = identity; sigma = identity 
Formula: bill_depth_mm ~ species + body_mass_g + (1 | dl | obs) 
         sigma = 1
         bill_length_mm ~ species + body_mass_g + (1 | dl | obs) 
         sigma = 1
   Data: penguins (Number of observations: 342) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~obs (Number of levels: 342) 
                                                  Estimate Est.Error l-95% CI
sd(billdepthmm_Intercept)                             0.24      0.06     0.12
sd(billlengthmm_Intercept)                            2.19      0.10     1.99
cor(billdepthmm_Intercept,billlengthmm_Intercept)     0.86      0.12     0.56
                                                  u-95% CI Rhat Bulk_ESS
sd(billdepthmm_Intercept)                             0.37 1.00     3611
sd(billlengthmm_Intercept)                            2.40 1.00     2279
cor(billdepthmm_Intercept,billlengthmm_Intercept)     0.99 1.03      120
                                                  Tail_ESS
sd(billdepthmm_Intercept)                             2463
sd(billlengthmm_Intercept)                            2897
cor(billdepthmm_Intercept,billlengthmm_Intercept)      186

Regression Coefficients:
                              Estimate Est.Error l-95% CI u-95% CI Rhat
billdepthmm_Intercept            12.77      0.45    11.90    13.66 1.00
billlengthmm_Intercept           24.92      1.06    22.83    27.04 1.00
billdepthmm_speciesChinstrap      0.02      0.15    -0.28     0.32 1.00
billdepthmm_speciesGentoo        -5.44      0.20    -5.84    -5.04 1.00
billdepthmm_body_mass_g           0.00      0.00     0.00     0.00 1.00
billlengthmm_speciesChinstrap     9.91      0.35     9.23    10.59 1.00
billlengthmm_speciesGentoo        3.56      0.49     2.61     4.50 1.00
billlengthmm_body_mass_g          0.00      0.00     0.00     0.00 1.00
                              Bulk_ESS Tail_ESS
billdepthmm_Intercept             6274     3682
billlengthmm_Intercept            3901     2911
billdepthmm_speciesChinstrap      8979     3053
billdepthmm_speciesGentoo         8305     3104
billdepthmm_body_mass_g           6725     3551
billlengthmm_speciesChinstrap     3046     2938
billlengthmm_speciesGentoo        3248     2885
billlengthmm_body_mass_g          3726     2759

Further Distributional Parameters:
                   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma_billdepthmm      1.00      0.00     1.00     1.00   NA       NA       NA
sigma_billlengthmm     1.00      0.00     1.00     1.00   NA       NA       NA

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>So we have a correlation of residuals of ~ 0.86. That’s pretty strong - and unsurprising given the physical constraints.</p>
</section>
<section id="confounders-and-instruments" class="level2">
<h2 class="anchored" data-anchor-id="confounders-and-instruments">Confounders and Instruments</h2>
<p>One place where correlated error becomes incredibly useful is instrumental variables. For those unfamiliar, in short, with an IV, we leverage this relationship: z -&gt; x -&gt; y in order to tease out the effect of x on y if the two are confounded. z provides unique information. Classically, we use techniques like two-stage-least-squares or others, as seen in <a href="https://cran.r-project.org/web/packages/ivreg/vignettes/ivreg.html">ivreg</a> or other packages.</p>
<p>To look at this, let’s examine data from Matt Whalen’s awesome <a href="https://esajournals.onlinelibrary.wiley.com/doi/10.1890/12-0156.1">seagrass SEM paper</a> that many of us use as a teaching demo. Jim Grace put it out in a fab <a href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13600">paper on IV</a> that’s worth a read for Ecologists.</p>
<p>In it, we have a system where grazers consume epiphytes on seagrass. But both grazers and epitphyes are jointly driven by seagrass and macroalgal abundance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dagify</span>(</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  epis <span class="sc">~</span> grazers <span class="sc">+</span> macroalgae <span class="sc">+</span> seagrass,</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  grazers <span class="sc">~</span> macroalgae <span class="sc">+</span> seagrass,</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> </span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tribble</span>(</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span>name, <span class="sc">~</span>x, <span class="sc">~</span>y,</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">"epis"</span>, <span class="dv">2</span>, <span class="dv">1</span>,</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">"grazers"</span>, <span class="dv">2</span>, <span class="dv">0</span>,</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"macroalgae"</span>, <span class="dv">1</span>, <span class="fl">0.5</span>,</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"seagrass"</span>, <span class="dv">3</span>, <span class="fl">0.5</span>)</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/whalen_dag_initial-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>However, Whalen et al.&nbsp;conducted an experiment where they imposed a treatment that altered grazer abundance. This serves as our instrument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dagify</span>(</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  epis <span class="sc">~</span> grazers <span class="sc">+</span> macroalgae <span class="sc">+</span> seagrass,</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  grazers <span class="sc">~</span> macroalgae <span class="sc">+</span> seagrass <span class="sc">+</span> trt,</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> </span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tribble</span>(</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span>name, <span class="sc">~</span>x, <span class="sc">~</span>y,</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">"epis"</span>, <span class="dv">2</span>, <span class="dv">1</span>,</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">"grazers"</span>, <span class="dv">2</span>, <span class="dv">0</span>,</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"macroalgae"</span>, <span class="dv">1</span>, <span class="fl">0.5</span>,</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"seagrass"</span>, <span class="dv">3</span>, <span class="fl">0.5</span>,</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">"trt"</span>, <span class="dv">2</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/whalen_dag_full-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now, let’s assume we did not have seagrass or macroalgae included. In order to fit a model, we’d need to have the errors of grazers and epiphytes be correlated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dagify</span>(</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  epis <span class="sc">~</span> grazers <span class="sc">+</span> e_epi,</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  grazers <span class="sc">~</span>  trt <span class="sc">+</span> e_grazer,</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  e_epi <span class="sc">~</span><span class="er">~</span> e_grazer,</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> </span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tribble</span>(</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span>name, <span class="sc">~</span>x, <span class="sc">~</span>y,</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"epis"</span>, <span class="dv">2</span>, <span class="dv">1</span>,</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"grazers"</span>, <span class="dv">2</span>, <span class="dv">0</span>,</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">"e_epi"</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">"e_grazer"</span>, <span class="dv">1</span>, <span class="dv">0</span>,</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">"trt"</span>, <span class="dv">2</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/iv_dag-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s fit three models. One with the confounders included, one with no correlated error, and one with correlated error in order to see how the coefficient estimate changes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>whalen <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"whalen_iv_ex.csv"</span>)</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>whalen_full_bf <span class="ot">&lt;-</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(grazers <span class="sc">~</span> trt <span class="sc">+</span> macroalgae <span class="sc">+</span> seagrass) <span class="sc">+</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(epis <span class="sc">~</span> grazers <span class="sc">+</span> macroalgae <span class="sc">+</span> seagrass) <span class="sc">+</span> </span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_rescor</span>(<span class="cn">FALSE</span>)</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>whalen_confound_bf <span class="ot">&lt;-</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(grazers <span class="sc">~</span> trt) <span class="sc">+</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(epis <span class="sc">~</span> grazers) <span class="sc">+</span> </span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_rescor</span>(<span class="cn">FALSE</span>)</span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>whalen_iv_bf <span class="ot">&lt;-</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(grazers <span class="sc">~</span> trt <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>ge<span class="sc">|</span>pole)) <span class="sc">+</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(epis <span class="sc">~</span> grazers<span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>ge<span class="sc">|</span>pole)) <span class="sc">+</span> </span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_rescor</span>(<span class="cn">FALSE</span>)</span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>whalen_full_brm <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a>  whalen_full_bf,</span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> whalen,</span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fit_models/whalen_full_brm.rds"</span>)</span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a>whalen_confound_brm <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a>  whalen_confound_bf,</span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> whalen,</span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fit_models/whalen_confound_brm.rds"</span>)</span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a>whalen_iv_brm <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a>  whalen_iv_bf,</span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> whalen,</span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"fit_models/whalen_ivl_brm.rds"</span>)</span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-33"><a href="#cb110-33" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb110-34"><a href="#cb110-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>(whalen_full_brm),</span>
<span id="cb110-35"><a href="#cb110-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>(whalen_confound_brm),</span>
<span id="cb110-36"><a href="#cb110-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>(whalen_iv_brm)) <span class="sc">|&gt;</span></span>
<span id="cb110-37"><a href="#cb110-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(response <span class="sc">==</span> <span class="st">"epis"</span>, term <span class="sc">==</span> <span class="st">"grazers"</span>) <span class="sc">|&gt;</span></span>
<span id="cb110-38"><a href="#cb110-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mod =</span> <span class="fu">c</span>(<span class="st">"full"</span>, <span class="st">"confound"</span>, <span class="st">"iv"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb110-39"><a href="#cb110-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mod, estimate, std.error, conf.low, conf.high)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  mod      estimate std.error conf.low conf.high
  &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 full       -0.948     0.114   -1.17     -0.718
2 confound   -0.703     0.120   -0.947    -0.460
3 iv         -0.907     0.179   -1.28     -0.589</code></pre>
</div>
</div>
<p>So, good overlap between the iv and the full, not so much with the confound.</p>
</section>
<section id="latent-variables" class="level2">
<h2 class="anchored" data-anchor-id="latent-variables">Latent Variables</h2>
<p>All of which leads to the last topic in SEM which currently piecewiseSEM doesn’t quite handle but is a core of covariance-based approaches - latent variables. Particularly, when we have a latent unmeasured variable and multiple indicators. Ironically, this is why I started writing this version of Bayesian SEM with brms (I’d done a bit on observed variables <a href="https://rpubs.com/jebyrnes/brms_bayes_sem">earlier here</a> and this effort came about due to me having to review an SEM methods paper and following up on two old threads <a href="https://github.com/paul-buerkner/brms/issues/303">here</a> and <a href="https://github.com/paul-buerkner/brms/issues/304">here</a> in the brms issues tracker).</p>
<p>Latent variables are an interesting beast. In essence, they are a missing variable. And they drive other things, but, we have to acknowledge that they are missing there as well. If we combine this with missing variables influencing multiple indicators AND imposing some constraints, we can identify the coefficients and latent variables.</p>
<p>This can be tricky - see <a href="https://arxiv.org/abs/2404.14124">here</a> for a nice piece by Luna Fazio and Paul Bürkner - and like in <code>blavaan</code> it’s generally better to fix a faactor loading to 1 as fixing the latent variable variance to 1 can result in unstable behavior <a href="https://www.jstatsoft.org/article/view/v085i04">see here</a>. We also need to think carefully about the prior for the latent variable. <code>blavaan</code> suggests something like a prior of gamma(1, 0.5) - see <a href="https://arxiv.org/abs/2301.08667">here</a>. Luna and Paul’s paper suggests something even wider, like a Gamma(11,11).</p>
<p>Let’s try something simple. One teaching example I use is the <em>Spartina</em> performance after transplant example from <a href="https://esajournals.onlinelibrary.wiley.com/doi/abs/10.1890/08-1443.1">Travis and Grace 2010</a>. Here, “performance” us a latent variable. What is performance? Is it the size of clones after transplants? Number of stems? Number of flowers? Height? Width? WHAT?!</p>
<p>There are all good indicators of an underlying performance variable.</p>
<p>Let’s start with a simple latent variable case.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dagify</span>(</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>    clonediam <span class="sc">~</span> performance, </span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    numbstems <span class="sc">~</span> performance,</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  numbinfl <span class="sc">~</span> performance,</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> </span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tribble</span>(</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span>name,         <span class="sc">~</span>x, <span class="sc">~</span>y,</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">"performance"</span>, <span class="dv">0</span>, <span class="dv">1</span>,</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"clonediam"</span>, <span class="dv">1</span>, <span class="dv">2</span>,</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"numbstems"</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">"numbinfl"</span>, <span class="dv">1</span>, <span class="dv">0</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">|&gt;</span></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/lv_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>OK, let’s first fit this in lavaan (or use blavaan if you want to be saucy). Note, it will also be WAY easier to standardize variables, so let’s do that.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>spartina <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"https://raw.githubusercontent.com/jebyrnes/semclass/refs/heads/master/files/data/TravisDataForLVExample.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">numbstems_s =</span> <span class="fu">scale</span>(numbstems),</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">clonediam_s =</span> <span class="fu">scale</span>(clonediam),</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">numbinfl_s =</span> <span class="fu">scale</span>(numbinfl),</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">meanht_s =</span> <span class="fu">scale</span>(meanht),</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">meanwidth_s =</span> <span class="fu">scale</span>(meanwidth),</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 23 Columns: 13
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (13): siteno, pathdist, pathdistcoded, pathdistsqr, geneticdist, numbste...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>performance_lv<span class="ot">&lt;-</span><span class="st">'</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="st">             # LV</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="st">             performance =~  </span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="st">               clonediam_s + </span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a><span class="st">               numbstems_s +</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a><span class="st">               numbinfl_s </span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a><span class="st">'</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>l_lv <span class="ot">&lt;-</span> <span class="fu">sem</span>(performance_lv, <span class="at">data =</span> spartina)</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(l_lv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>lavaan 0.6.17 ended normally after 28 iterations

  Estimator                                         ML
  Optimization method                           NLMINB
  Number of model parameters                         6

  Number of observations                            23

Model Test User Model:
                                                      
  Test statistic                                 0.000
  Degrees of freedom                                 0

Parameter Estimates:

  Standard errors                             Standard
  Information                                 Expected
  Information saturated (h1) model          Structured

Latent Variables:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
  performance =~                                      
    clonediam_s       1.000                           
    numbstems_s       1.026    0.095   10.784    0.000
    numbinfl_s        0.894    0.131    6.798    0.000

Variances:
                   Estimate  Std.Err  z-value  P(&gt;|z|)
   .clonediam_s       0.087    0.051    1.705    0.088
   .numbstems_s       0.040    0.048    0.846    0.397
   .numbinfl_s        0.262    0.085    3.088    0.002
    performance       0.870    0.284    3.060    0.002</code></pre>
</div>
</div>
<p>Classic. Now, with brms, we have to define the LV as intercept only but as a missing variable. It affects all indicators, but it missing. And last, we have to set some priors. For the LV, let’s go with a Gamma. But, for the performance -&gt; clonediam, to be equivalent to the lavaan model above, we’ll need a constant.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>bf_lv <span class="ot">&lt;-</span> </span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The LV itself - performance given missingness</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(performance <span class="sc">|</span> <span class="fu">mi</span>() <span class="sc">~</span>  <span class="dv">0</span>) <span class="sc">+</span>  </span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># latent variable indicators</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(clonediam_s <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">mi</span>(performance)) <span class="sc">+</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(numbstems_s <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">mi</span>(performance)) <span class="sc">+</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(numbinfl_s <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">mi</span>(performance)) <span class="sc">+</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_rescor</span>(<span class="cn">FALSE</span>)</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a><span class="co"># priors</span></span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>priors_lv <span class="ot">&lt;-</span> <span class="fu">prior</span>(<span class="fu">constant</span>(<span class="dv">1</span>), </span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">coef =</span> <span class="st">"miperformance"</span>, </span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>                          <span class="at">resp =</span> <span class="st">"clonediams"</span>) <span class="sc">+</span></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">gamma</span>(<span class="dv">11</span>, <span class="dv">11</span>), <span class="at">class =</span> <span class="st">"sigma"</span>, <span class="at">resp =</span> <span class="st">"performance"</span>)</span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a><span class="co"># now the fit - note, we have to add an NA</span></span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a><span class="co"># for performance column</span></span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>b_lv <span class="ot">&lt;-</span> <span class="fu">brm</span>(bf_lv, </span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> spartina <span class="sc">|&gt;</span> </span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">performance =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>)),</span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">prior =</span> priors_lv,</span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">file =</span> <span class="st">"fit_models/b_lv.rds"</span></span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I really like how this formulation shows off that indicators are CAUSED by the latent variable. I find some students have trouble with that with the lavaan syntax, as what is on the RHS and LHS of the =~ has different causal meaning than just ~.</p>
<p>Now, the standard deviations from both <code>lavaan</code> and <code>brms</code> fits -</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remember to sqrt so we compare sigma to sigma!</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(l_lv) <span class="sc">|&gt;</span> <span class="fu">filter</span>(op <span class="sc">==</span><span class="st">"~~"</span>) <span class="sc">|&gt;</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">estimate =</span> <span class="fu">sqrt</span>(estimate),</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">std.error =</span> <span class="fu">sqrt</span>(std.error),</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>         )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 9
  term         op    estimate std.error statistic p.value std.lv std.all std.nox
  &lt;chr&gt;        &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 clonediam_s… ~~       0.294     0.225     1.70  0.0882  0.0866  0.0905  0.0905
2 numbstems_s… ~~       0.201     0.218     0.846 0.397   0.0404  0.0422  0.0422
3 numbinfl_s … ~~       0.512     0.291     3.09  0.00201 0.262   0.274   0.274 
4 performance… ~~       0.933     0.533     3.06  0.00221 1       1       1     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(b_lv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 9
  response    effect component group term  estimate std.error conf.low conf.high
  &lt;chr&gt;       &lt;chr&gt;  &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 performance ran_p… cond      Resi… sd__…    0.958    0.142    0.707      1.27 
2 clonediams  ran_p… cond      Resi… sd__…    0.293    0.112    0.0335     0.492
3 numbstemss  ran_p… cond      Resi… sd__…    0.232    0.110    0.0379     0.448
4 numbinfls   ran_p… cond      Resi… sd__…    0.566    0.0989   0.401      0.779</code></pre>
</div>
</div>
<p>Not bad for the variances. What about the loadings?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(l_lv) <span class="sc">|&gt;</span> <span class="fu">filter</span>(op <span class="sc">==</span><span class="st">"=~"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 9
  term       op    estimate std.error statistic   p.value std.lv std.all std.nox
  &lt;chr&gt;      &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 performan… =~       1        0          NA    NA         0.933   0.954   0.954
2 performan… =~       1.03     0.0952     10.8   0         0.957   0.979   0.979
3 performan… =~       0.894    0.131       6.80  1.06e-11  0.833   0.852   0.852</code></pre>
</div>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixef</span>(b_lv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                          Estimate Est.Error      Q2.5    Q97.5
numbstemss_miperformance 1.0344453 0.1136121 0.8333402 1.272417
numbinfls_miperformance  0.8978637 0.1549107 0.6205271 1.230368
clonediams_miperformance 1.0000000 0.0000000 1.0000000 1.000000</code></pre>
</div>
</div>
<p>Very nice! Further, we can actually look at fitted model to get our latent variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>performance_lv <span class="ot">&lt;-</span> </span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tidy_draws</span>(b_lv) <span class="sc">|&gt;</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(.chain, .iteration, .draw, </span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Ymi_performance[1]</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">Ymi_performance[23]</span><span class="st">`</span>)) <span class="sc">|&gt;</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="st">`</span><span class="at">Ymi_performance[1]</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">Ymi_performance[23]</span><span class="st">`</span>)</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(performance_lv,</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> name,</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_halfeye</span>() <span class="sc">+</span></span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x=</span><span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/lv_plot_it-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>OK, so…….. what does this mean for a Full Luxury Bayesian SEM? (credit to Richard McElreath for a variation on his phrase which comes from…. yeah, you look it up).</p>
<p>Well, it’s all models. Models all the way down. We can now put together a model, and let’s go bit. Now, genetic distance predicts performance. And for funsies, we’ll add two more indicators - mean height and mean width, but they’re correlated beyond just what performance does as, well, they’re physically linked.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dagify</span>(</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>    performance <span class="sc">~</span> geneticdist,</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    clonediam <span class="sc">~</span> performance, </span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    numbstems <span class="sc">~</span> performance,</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    numbinfl <span class="sc">~</span> performance,</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    meanht <span class="sc">~</span> performance,</span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>    meanwidth <span class="sc">~</span> performance,</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>    meanht <span class="sc">~</span><span class="er">~</span> meanwidth,</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> </span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tribble</span>(</span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span>name,         <span class="sc">~</span>x, <span class="sc">~</span>y,</span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">"geneticdist"</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">"performance"</span>, <span class="dv">0</span>, <span class="dv">1</span>,</span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">"clonediam"</span>, <span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">"numbstems"</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">"numbinfl"</span>, <span class="dv">1</span>, <span class="dv">0</span>,</span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>      <span class="st">"meanht"</span>, <span class="dv">1</span>, <span class="dv">2</span>,</span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">"meanwidth"</span>, <span class="dv">1</span>, <span class="dv">4</span>,</span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">|&gt;</span></span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/sem_full_plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>OK, so, let’s get into it. First, our model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>f_spartina <span class="ot">&lt;-</span> </span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># data generating process and definint the LV</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(performance <span class="sc">|</span> <span class="fu">mi</span>() <span class="sc">~</span> geneticdist <span class="sc">+</span> <span class="dv">0</span>) <span class="sc">+</span>  </span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># latent variable indicators</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(clonediam_s <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">mi</span>(performance)) <span class="sc">+</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(numbstems_s <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">mi</span>(performance)) <span class="sc">+</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(numbinfl_s <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> <span class="fu">mi</span>(performance)) <span class="sc">+</span></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># correlated residuals indicators of LV </span></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(meanht_s <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>c<span class="sc">|</span>siteno) <span class="sc">+</span> <span class="fu">mi</span>(performance), </span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">sigma =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(meanwidth_s <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>c<span class="sc">|</span>siteno)<span class="sc">+</span> <span class="fu">mi</span>(performance), </span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">sigma =</span> <span class="dv">1</span>)  <span class="sc">+</span></span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_rescor</span>(<span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is straightfoward given EVERYTHING above. HA. Now, let’s set some priors. Note, because of the correlated error, we set priors on <code>sd</code> instead of <code>sigma</code> for height and width. Use <code>get_prior()</code> on <code>f_spartina</code> to see the names used in priors and as variables in the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>prior_spartina <span class="ot">&lt;-</span>  <span class="fu">prior</span>(<span class="fu">constant</span>(<span class="dv">1</span>), </span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">coef =</span> <span class="st">"miperformance"</span>, </span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">resp =</span> <span class="st">"clonediams"</span>) <span class="sc">+</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">gamma</span>(<span class="dv">1</span>, .<span class="dv">5</span>), </span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">class =</span> <span class="st">"sigma"</span>, </span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">resp =</span> <span class="st">"clonediams"</span>) <span class="sc">+</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">gamma</span>(<span class="dv">1</span>, .<span class="dv">5</span>), </span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">class =</span> <span class="st">"sigma"</span>, </span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>                    <span class="at">resp =</span> <span class="st">"numbinfls"</span>)<span class="sc">+</span></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">gamma</span>(<span class="dv">1</span>, .<span class="dv">5</span>), </span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">class =</span> <span class="st">"sigma"</span>, </span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">resp =</span> <span class="st">"numbstemss"</span>)<span class="sc">+</span></span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">gamma</span>(<span class="dv">1</span>, .<span class="dv">5</span>), </span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>                    <span class="at">class =</span> <span class="st">"sd"</span>, </span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>                    <span class="at">resp =</span> <span class="st">"meanhts"</span>) <span class="sc">+</span></span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>                <span class="fu">prior</span>(<span class="fu">gamma</span>(<span class="dv">1</span>, .<span class="dv">5</span>), </span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>                    <span class="at">class =</span> <span class="st">"sd"</span>, </span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>                    <span class="at">resp =</span> <span class="st">"meanwidths"</span>) <span class="sc">+</span></span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>              <span class="fu">prior</span>(<span class="fu">gamma</span>(<span class="dv">11</span>, <span class="dv">11</span>), </span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a>                    <span class="at">class =</span> <span class="st">"sigma"</span>, </span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a>                    <span class="at">resp =</span> <span class="st">"performance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could probably reel in the performance sigma prior, but, let’s stick with it for the moment. Note, I’m specifying the others as well in order to try and improve performance. One might want to try something else - one of the defaults - but let’s try this out.</p>
<p>And now, the fit. Whew!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit with handling the LV the same as lavaan</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>mod_spartina <span class="ot">&lt;-</span> <span class="fu">brm</span>(f_spartina, </span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> spartina <span class="sc">|&gt;</span> </span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">mutate</span>(<span class="at">performance =</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">as.numeric</span>(<span class="cn">NA</span>)),</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prior =</span> prior_spartina,</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">file =</span> <span class="st">"fit_models/mod_spartina.rds"</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Could this be improved? Probably, but, it’s not bad in terms of output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mod_spartina)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There were 40 divergent transitions after warmup. Increasing
adapt_delta above 0.8 may help. See
http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: MV(gaussian, gaussian, gaussian, gaussian, gaussian, gaussian) 
  Links: mu = identity; sigma = identity
         mu = identity; sigma = identity
         mu = identity; sigma = identity
         mu = identity; sigma = identity
         mu = identity; sigma = identity
         mu = identity; sigma = identity 
Formula: performance | mi() ~ geneticdist + 0 
         clonediam_s ~ 0 + mi(performance) 
         numbstems_s ~ 0 + mi(performance) 
         numbinfl_s ~ 0 + mi(performance) 
         meanht_s ~ 0 + (1 | c | siteno) + mi(performance) 
         sigma = 1
         meanwidth_s ~ 0 + (1 | c | siteno) + mi(performance) 
         sigma = 1
   Data: mutate(spartina, performance = as.numeric(NA)) (Number of observations: 23) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Multilevel Hyperparameters:
~siteno (Number of levels: 23) 
                                            Estimate Est.Error l-95% CI
sd(meanhts_Intercept)                           0.23      0.18     0.01
sd(meanwidths_Intercept)                        0.24      0.19     0.01
cor(meanhts_Intercept,meanwidths_Intercept)     0.12      0.58    -0.94
                                            u-95% CI Rhat Bulk_ESS Tail_ESS
sd(meanhts_Intercept)                           0.69 1.00     1952     1869
sd(meanwidths_Intercept)                        0.71 1.00     2205     1651
cor(meanhts_Intercept,meanwidths_Intercept)     0.96 1.00     3253     2325

Regression Coefficients:
                         Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
performance_geneticdist     -0.98      0.51    -1.95     0.05 1.00     3219
numbstemss_miperformance     1.01      0.10     0.82     1.22 1.01      449
numbinfls_miperformance      0.88      0.15     0.61     1.19 1.00     1437
meanhts_miperformance        0.81      0.24     0.36     1.30 1.00     2926
meanwidths_miperformance     0.74      0.24     0.27     1.21 1.00     3635
clonediams_miperformance     1.00      0.00     1.00     1.00   NA       NA
                         Tail_ESS
performance_geneticdist      2754
numbstemss_miperformance     1515
numbinfls_miperformance      2426
meanhts_miperformance        1742
meanwidths_miperformance     2768
clonediams_miperformance       NA

Further Distributional Parameters:
                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma_performance     0.92      0.14     0.69     1.22 1.00     2110     2245
sigma_clonediams      0.25      0.11     0.04     0.45 1.05      122      154
sigma_numbstemss      0.28      0.10     0.06     0.46 1.02      196      230
sigma_numbinfls       0.57      0.10     0.40     0.81 1.00     1592     1107
sigma_meanhts         1.00      0.00     1.00     1.00   NA       NA       NA
sigma_meanwidths      1.00      0.00     1.00     1.00   NA       NA       NA

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>We can also check posterior diagnostics and assess model fit using the same techniques as we had above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>f_spartina<span class="sc">$</span>responses <span class="sc">|&gt;</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(<span class="sc">~</span><span class="fu">pp_check</span>(mod_spartina, </span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">resp =</span> .x,</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ndraws =</span> <span class="dv">100</span>) <span class="sc">+</span> </span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>               <span class="fu">labs</span>(<span class="at">title =</span> .x)) <span class="sc">|&gt;</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">wrap_plots</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: NA responses are not shown in 'pp_check'.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/check_posteriors_sem-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>While we can’t assess fit of performance as it’s a latent variable, the rest look pretty nice! We could, of course, test conditional independence relationships between genetic distance and the indicators. But, overall, we now have a template for moving forward.</p>
</section>
<section id="multilevel-sem" class="level2">
<h2 class="anchored" data-anchor-id="multilevel-sem">Multilevel SEM</h2>
<p>Last, something that’s been a bit of a white whale for me for some time. What if we want to fit an SEM, but, we are modeling different levels of the system. For example, there are relationships happening at the plot level. And there are relationships happening at the site level. This is hierarchical/multilevel modeling. We typically do it with a single response variable, BUT, we don’t model relationships between level-2 predictors, which is unfortunate.</p>
<p><code>lavaan</code> gives us the ability to model relationships at different levels. Theoretically, <code>piecewiseSEM</code> does as well, although you have to fit different models, and then piece together your own bespoke conditional independence tests. Then again, a lot about Bayes is bespoke, so, how different is that, really.</p>
<p>But I wanted a one stop shop. Ages ago, I simulated some data where the abundance of <a href="https://www.google.com/search?udm=2&amp;q=ostracods">ostracods</a> was determined by algal cover in the summer at a plto level as well as average phytoplankton at a site level in the winter. This winter phytoplankton at the site level was in turn determined by winter temperature.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dagify</span>(</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>  ostracod_abund <span class="sc">~</span> algal_cover <span class="sc">+</span> winter_phytoplankton,</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  winter_phytoplankton <span class="sc">~</span> winter_temperature,</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">tribble</span>(</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>name,          <span class="sc">~</span>x, <span class="sc">~</span>y,</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ostracod_abund"</span>, <span class="dv">1</span>, <span class="dv">2</span>,</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"algal_cover"</span>,    <span class="dv">0</span>, <span class="dv">2</span>,</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"winter_phytoplankton"</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"winter_temperature"</span>, <span class="dv">1</span>, <span class="dv">0</span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bayesian_sem_files/figure-html/ostra_dag-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Using <code>lavaan</code> we need to specify levels in the model itself as well as supply what we’re grouping on. It’s quite nice, really.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>ostra_plot <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://raw.githubusercontent.com/sem-eeb/semclass/refs/heads/master/files/data/ostracod_plotlevel.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 100 Columns: 6
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (1): site
dbl (5): winter_temp, winter_upwelling, winter_phytoplankton, algal_cover, o...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># basic model</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>ostra_mod <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="st">  #level 1 is within - plot level</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a><span class="st">  level: 1</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a><span class="st">  ostracod_abund ~  algal_cover</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a><span class="st">  #level 2 is between - site level</span></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a><span class="st">  level: 2</span></span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a><span class="st">  ostracod_abund ~ winter_phytoplankton</span></span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a><span class="st">  winter_phytoplankton ~ winter_temp</span></span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a><span class="st">"</span></span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>ostra_fit <span class="ot">&lt;-</span> <span class="fu">sem</span>(ostra_mod, <span class="at">data =</span> ostra_plot,</span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a>                 <span class="at">cluster =</span> <span class="st">"site"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How does that fit into the world of ‘brms’? Do we need site and plot level data to make this work, as we would in <code>piecewiseSEM</code>?</p>
<p>We can actually take a note from what we’ve done previously with correlated errors. There, we set sigma for a variable to 1 and then modeled the variance as a random effect. For the site-level relationships, we can do the same - include a site-level random effect, which will signal to <code>brms</code> that we have a hierarchical model. But, as all of that variance is at the site-level, we can fix our sigma for the response, thus pushing the variance to the correct place in the model. It’s a bit of a kludge, but it does work. We need to do this as, otherwise, site-level coefficients would all have far too narrow a posterior, as the software would assume too much replication based on our data frame. Let’s show an example with the ostracod model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>ostra_bf <span class="ot">&lt;-</span> </span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#level 1 is within - plot level</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(ostracod_abund <span class="sc">~</span>  algal_cover <span class="sc">+</span> </span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>       winter_phytoplankton <span class="sc">+</span> </span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>       (<span class="dv">1</span><span class="sc">|</span>site)) <span class="sc">+</span></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#level 2 is between - site level</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(winter_phytoplankton <span class="sc">~</span> winter_temp <span class="sc">+</span> </span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>       (<span class="dv">1</span><span class="sc">|</span>site), </span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">sigma =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_rescor</span>(<span class="cn">FALSE</span>)</span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a><span class="co">#fit</span></span>
<span id="cb140-15"><a href="#cb140-15" aria-hidden="true" tabindex="-1"></a>ostra_brm <span class="ot">&lt;-</span> <span class="fu">brm</span>(ostra_bf, </span>
<span id="cb140-16"><a href="#cb140-16" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> ostra_plot,</span>
<span id="cb140-17"><a href="#cb140-17" aria-hidden="true" tabindex="-1"></a>                 <span class="at">file =</span> <span class="st">"fit_models/ostra_brm.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
</div>
<p>We can see the coefficients broadly line up.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ostra_fit) <span class="sc">|&gt;</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(term, estimate, std.error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 3
   term                                           estimate std.error
   &lt;chr&gt;                                             &lt;dbl&gt;     &lt;dbl&gt;
 1 "ostracod_abund ~ algal_cover"                    0.324    0.0192
 2 "ostracod_abund ~~ ostracod_abund"               24.2      3.61  
 3 "algal_cover ~~ algal_cover"                    693.       0     
 4 "ostracod_abund ~1 "                              0        0     
 5 "algal_cover ~1 "                                56.4      0     
 6 "ostracod_abund ~ winter_phytoplankton"           7.24     1.28  
 7 "winter_phytoplankton ~ winter_temp"              0.796    0.261 
 8 "ostracod_abund ~~ ostracod_abund"               28.8     14.0   
 9 "winter_phytoplankton ~~ winter_phytoplankton"    0.995    0.445 
10 "winter_temp ~~ winter_temp"                      1.46     0     
11 "ostracod_abund ~1 "                              3.39    10.5   
12 "winter_phytoplankton ~1 "                        5.71     0.852 
13 "winter_temp ~1 "                                 3.04     0     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ostra_brm)<span class="sc">|&gt;</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(response, term, estimate, std.error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 4
  response            term                                   estimate std.error
  &lt;chr&gt;               &lt;chr&gt;                                     &lt;dbl&gt;     &lt;dbl&gt;
1 ostracodabund       (Intercept)                               3.32    13.9   
2 winterphytoplankton (Intercept)                               5.69     1.16  
3 ostracodabund       algal_cover                               0.324    0.0194
4 ostracodabund       winter_phytoplankton                      7.24     1.70  
5 winterphytoplankton winter_temp                               0.800    0.363 
6 site                sd__NA.ostracodabund_(Intercept)          7.07     2.10  
7 site                sd__NA.winterphytoplankton_(Intercept)    1.25     0.395 
8 ostracodabund       sd__Observation                           5.02     0.377 
9 winterphytoplankton sd__Observation                           1        0     </code></pre>
</div>
</div>
<p>Woo! This works! There’s a lot more to explore here - fit, predictions, etc., but, this seems like a good place to leave off.</p>
</section>
<section id="comments" class="level2">
<h2 class="anchored" data-anchor-id="comments">Comments?</h2>
<p>I’m putting this on github as I want to version and change it. I hope to put it up in pieces on my blog at some point. For now, if you have questions, comments, suggestions for fixing things, or point out stuff I’ve done wrong, post an <a href="https://github.com/jebyrnes/Ecological-SEMs-in-lavaan/issues">issue on the repo for this tutorial</a></p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>